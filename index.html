<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PM-POSHAN Mid-Day Meal Management</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1a237e, #0d47a1, #01579b);
            --secondary-gradient: linear-gradient(135deg, #01579b, #0277bd, #0288d1);
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-dark: #263238;
            --text-light: #ffffff;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Nunito', 'Poppins', sans-serif;
            background: var(--primary-gradient);
            color: var(--text-dark);
            min-height: 100vh;
            font-size: 0.75rem;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .app-header {
            background: var(--secondary-gradient);
            color: var(--text-light);
            padding: 10px;
            text-align: center;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
        }

        .app-header h1 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .app-header p {
            font-size: 0.7rem;
            margin: 0;
            opacity: 0.9;
        }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .school-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .school-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .school-details h2 {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .school-details p {
            font-size: 0.65rem;
            margin: 0;
            color: #546e7a;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 70px;
            text-align: center;
            padding: 8px 5px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
            margin: 2px;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: #01579b;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #546e7a;
        }

        .chart-container {
            height: 200px;
            margin-bottom: 10px;
        }

        .entry-form {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .entry-input {
            flex: 1;
            min-width: 80px;
            margin: 2px;
        }

        .entry-input label {
            display: block;
            font-size: 0.65rem;
            margin-bottom: 3px;
            color: #546e7a;
        }

        .entry-input input {
            width: 100%;
            padding: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.75rem;
        }

        .btn-primary-custom {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .btn-primary-custom:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
            color: white;
        }

        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--secondary-gradient);
            color: var(--text-light);
            text-align: center;
            padding: 6px;
            font-size: 0.65rem;
        }

        .nav-tabs {
            display: flex;
            justify-content: space-around;
            background: var(--secondary-gradient);
            border-radius: 8px;
            margin: 10px;
            padding: 3px;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 8px 5px;
            color: var(--text-light);
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .nav-tab i {
            display: block;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 0.7rem;
            margin-bottom: 3px;
            font-weight: 600;
            color: #455a64;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .table-responsive {
            margin: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 0.7rem;
        }

        .table {
            font-size: 0.65rem;
        }

        .table th {
            background: var(--secondary-gradient);
            color: white;
            font-weight: 600;
            padding: 6px;
            position: sticky;
            top: 0;
        }

        .table td {
            padding: 4px;
            vertical-align: middle;
        }

        .toast-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1050;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow-hover);
            margin-bottom: 8px;
            overflow: hidden;
            font-size: 0.7rem;
        }

        .toast-header {
            background: var(--secondary-gradient);
            color: white;
            padding: 8px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .toast-body {
            padding: 8px;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
            font-size: 0.75rem;
        }

        .modal-header {
            background: var(--secondary-gradient);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 10px;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .settings-section {
            margin-bottom: 15px;
        }

        .settings-section h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #01579b;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 3px;
        }

        .settings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        .settings-table th {
            background: #f5f5f5;
            padding: 6px;
            text-align: left;
            font-weight: 600;
            color: #455a64;
        }

        .settings-table td {
            padding: 6px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-table input, .settings-table select {
            width: 100%;
            padding: 4px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .btn-danger-custom {
            background: #e53935;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .btn-danger-custom:hover {
            background: #c62828;
            color: white;
        }

        .btn-secondary-custom {
            background: #546e7a;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .btn-secondary-custom:hover {
            background: #37474f;
            color: white;
        }

        .btn-success-custom {
            background: #43a047;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            width: 100%;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .btn-success-custom:hover {
            background: #2e7d32;
            color: white;
        }

        .analytics-chart-container {
            height: 250px;
            margin: 10px;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .sub-nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 6px;
            margin: 0 10px 10px;
            padding: 3px;
            flex-wrap: wrap;
        }

        .sub-nav-tab {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: 6px 3px;
            color: #455a64;
            border-radius: 4px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.65rem;
        }

        .sub-nav-tab.active {
            background: white;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .abstract-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.7rem;
        }

        .abstract-table th {
            background: var(--secondary-gradient);
            color: white;
            padding: 6px;
            text-align: left;
        }

        .abstract-table td {
            padding: 6px;
            border-bottom: 1px solid #e0e0e0;
        }

        .abstract-table tr:last-child td {
            border-bottom: none;
            font-weight: 600;
        }

        .entry-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .entry-section h4 {
            font-size: 0.85rem;
            margin-bottom: 10px;
            color: #01579b;
        }

        .note-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #856404;
        }

        .helper-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.7rem;
        }

        .helper-table th, .helper-table td {
            padding: 6px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        .helper-table th {
            background: #f5f5f5;
        }

        .add-helper-btn {
            background: #43a047;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: 8px;
            cursor: pointer;
        }

        .add-helper-btn:hover {
            background: #2e7d32;
        }

        .remove-helper-btn {
            background: #e53935;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            cursor: pointer;
        }

        .remove-helper-btn:hover {
            background: #c62828;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #01579b;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .action-buttons .btn {
            flex: 1;
            margin: 0 3px;
            font-size: 0.7rem;
            padding: 8px;
        }

        .export-card {
            background: linear-gradient(135deg, #1a237e, #0d47a1);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            box-shadow: var(--shadow-hover);
            text-align: center;
        }

        .export-card h3 {
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .export-card p {
            font-size: 0.7rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .export-card .btn {
            background: white;
            color: #1a237e;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.75rem;
            width: 100%;
        }

        .export-card .btn:hover {
            background: #f5f5f5;
            color: #1a237e;
        }

        .progress-container {
            margin: 15px 0;
            display: none;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.3);
        }

        .progress-bar {
            background-color: white;
            border-radius: 5px;
        }

        .validation-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.7rem;
            display: none;
        }

        .validation-message.success {
            background: #d4edda;
            color: #155724;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .settings-grid .form-group {
            margin-bottom: 0;
        }

        .settings-full-width {
            grid-column: 1 / -1;
        }

        @media print {
            body {
                background: white;
            }

            .app-header,
            .nav-tabs,
            .sub-nav-tabs,
            .app-footer,
            .btn,
            .modal {
                display: none;
            }

            .dashboard-card {
                box-shadow: none;
                border: 1px solid #e0e0e0;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <h1>PM-POSHAN Mid-Day Meal</h1>
            <p>Government of India</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-tab" data-tab="summary">
                <i class="bi bi-table"></i>
                <span>Summary</span>
            </div>
            <div class="nav-tab" data-tab="abstracts">
                <i class="bi bi-calculator"></i>
                <span>Abstracts</span>
            </div>
            <div class="nav-tab" data-tab="export">
                <i class="bi bi-file-earmark-pdf"></i>
                <span>Export</span>
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="dashboard-card">
                <div class="school-info">
                    <div class="school-logo">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="school-details">
                        <h2 id="dashboard-school-name">School Name</h2>
                        <p>UDISE: <span id="dashboard-udise">00000000000</span></p>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-value" id="dashboard-date">--</div>
                        <div class="stat-label">Date</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dashboard-expenditure">₹0.00</div>
                        <div class="stat-label">Expenditure</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dashboard-rice">0 kg</div>
                        <div class="stat-label">Rice</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dashboard-students">0</div>
                        <div class="stat-label">Students</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>

                <div class="entry-form">
                    <div class="entry-input">
                        <label for="dashboard-balvatika">Balvatika</label>
                        <input type="number" id="dashboard-balvatika" min="0" placeholder="0">
                    </div>
                    <div class="entry-input">
                        <label for="dashboard-primary">Primary</label>
                        <input type="number" id="dashboard-primary" min="0" placeholder="0">
                    </div>
                    <div class="entry-input">
                        <label for="dashboard-middle">Middle</label>
                        <input type="number" id="dashboard-middle" min="0" placeholder="0">
                    </div>
                </div>

                <button class="btn-primary-custom" id="dashboard-save-btn">
                    <i class="bi bi-save"></i> Save Today's Entry
                </button>
            </div>
        </div>

        <!-- Summary Tab -->
        <div class="tab-content" id="summary">
            <div class="dashboard-card">
                <h3 class="mb-3">Monthly Summary</h3>
                
                <div class="form-group">
                    <label for="summary-month">Select Month</label>
                    <select id="summary-month" class="form-control">
                        <option value="">-- Select Month --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="summary-category">Category</label>
                    <select id="summary-category" class="form-control">
                        <option value="all">All</option>
                        <option value="balvatika">Balvatika</option>
                        <option value="primary">Primary</option>
                        <option value="middle">Middle</option>
                    </select>
                </div>

                <button class="btn-primary-custom mb-3" id="summary-generate-btn">
                    <i class="bi bi-table"></i> Generate Summary
                </button>

                <div class="table-responsive">
                    <table class="table table-striped" id="summary-table">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Date</th>
                                <th>On-Roll</th>
                                <th>Present</th>
                                <th>Rice (kg)</th>
                                <th>Total (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">No data available. Please select a month and generate summary.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rice Entry Section -->
            <div class="dashboard-card">
                <div class="entry-section">
                    <h4><i class="bi bi-basket"></i> Rice Entry</h4>
                    
                    <div class="form-group">
                        <label for="summary-rice-date">Date</label>
                        <input type="date" id="summary-rice-date" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Rice Received (kg)</label>
                        <div class="entry-form">
                            <div class="entry-input">
                                <label for="summary-rice-balvatika">Balvatika</label>
                                <input type="number" id="summary-rice-balvatika" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                            <div class="entry-input">
                                <label for="summary-rice-primary">Primary</label>
                                <input type="number" id="summary-rice-primary" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                            <div class="entry-input">
                                <label for="summary-rice-middle">Middle</label>
                                <input type="number" id="summary-rice-middle" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Total Rice Received</label>
                        <input type="number" id="summary-rice-total" min="0" step="0.01" class="form-control" readonly>
                    </div>

                    <button class="btn-primary-custom" id="summary-rice-save-btn">
                        <i class="bi bi-save"></i> Save Rice Entry
                    </button>
                </div>
            </div>

            <!-- Cash Entry Section -->
            <div class="dashboard-card">
                <div class="entry-section">
                    <h4><i class="bi bi-cash"></i> Cash Entry</h4>
                    
                    <div class="form-group">
                        <label for="summary-cash-date">Date</label>
                        <input type="date" id="summary-cash-date" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Cash Received (₹)</label>
                        <div class="entry-form">
                            <div class="entry-input">
                                <label for="summary-cash-balvatika">Balvatika</label>
                                <input type="number" id="summary-cash-balvatika" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                            <div class="entry-input">
                                <label for="summary-cash-primary">Primary</label>
                                <input type="number" id="summary-cash-primary" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                            <div class="entry-input">
                                <label for="summary-cash-middle">Middle</label>
                                <input type="number" id="summary-cash-middle" min="0" step="0.01" class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Total Cash Received</label>
                        <input type="number" id="summary-cash-total" min="0" step="0.01" class="form-control" readonly>
                    </div>

                    <button class="btn-primary-custom" id="summary-cash-save-btn">
                        <i class="bi bi-save"></i> Save Cash Entry
                    </button>
                </div>
            </div>
        </div>

        <!-- Abstracts Tab -->
        <div class="tab-content" id="abstracts">
            <div class="dashboard-card">
                <h3 class="mb-3">Category-wise Abstracts</h3>
                
                <div class="form-group">
                    <label for="abstracts-month">Select Month</label>
                    <select id="abstracts-month" class="form-control">
                        <option value="">-- Select Month --</option>
                    </select>
                </div>

                <button class="btn-primary-custom mb-3" id="abstracts-generate-btn">
                    <i class="bi bi-calculator"></i> Generate Abstracts
                </button>

                <h4 class="mb-2">Rice Abstract (kg)</h4>
                <table class="abstract-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Consumed</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Balvatika</td>
                            <td id="rice-balvatika-opening">0</td>
                            <td id="rice-balvatika-received">0</td>
                            <td id="rice-balvatika-consumed">0</td>
                            <td id="rice-balvatika-balance">0</td>
                        </tr>
                        <tr>
                            <td>Primary</td>
                            <td id="rice-primary-opening">0</td>
                            <td id="rice-primary-received">0</td>
                            <td id="rice-primary-consumed">0</td>
                            <td id="rice-primary-balance">0</td>
                        </tr>
                        <tr>
                            <td>Middle</td>
                            <td id="rice-middle-opening">0</td>
                            <td id="rice-middle-received">0</td>
                            <td id="rice-middle-consumed">0</td>
                            <td id="rice-middle-balance">0</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td id="rice-total-opening">0</td>
                            <td id="rice-total-received">0</td>
                            <td id="rice-total-consumed">0</td>
                            <td id="rice-total-balance">0</td>
                        </tr>
                    </tbody>
                </table>

                <h4 class="mb-2 mt-3">Cash Abstract (₹)</h4>
                <table class="abstract-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Expenditure</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Balvatika</td>
                            <td id="cash-balvatika-opening">0</td>
                            <td id="cash-balvatika-received">0</td>
                            <td id="cash-balvatika-expenditure">0</td>
                            <td id="cash-balvatika-balance">0</td>
                        </tr>
                        <tr>
                            <td>Primary</td>
                            <td id="cash-primary-opening">0</td>
                            <td id="cash-primary-received">0</td>
                            <td id="cash-primary-expenditure">0</td>
                            <td id="cash-primary-balance">0</td>
                        </tr>
                        <tr>
                            <td>Middle</td>
                            <td id="cash-middle-opening">0</td>
                            <td id="cash-middle-received">0</td>
                            <td id="cash-middle-expenditure">0</td>
                            <td id="cash-middle-balance">0</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td id="cash-total-opening">0</td>
                            <td id="cash-total-received">0</td>
                            <td id="cash-total-expenditure">0</td>
                            <td id="cash-total-balance">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Tab -->
        <div class="tab-content" id="export">
            <div class="export-card">
                <h3><i class="bi bi-file-earmark-pdf"></i> Official PM POSHAN Monthly Report (MDCF)</h3>
                <p>Generate a pre-filled, calculated PDF report by pulling and processing data from existing app modules</p>
                
                <div class="form-group">
                    <label for="export-month">Select Month</label>
                    <select id="export-month" class="form-control">
                        <option value="">-- Select Month --</option>
                    </select>
                </div>
                
                <div class="validation-message" id="export-validation-message"></div>
                
                <div class="progress-container" id="export-progress-container">
                    <div class="progress">
                        <div class="progress-bar" id="export-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-1" id="export-progress-text">Processing...</div>
                </div>
                
                <button class="btn" id="export-generate-btn">
                    <i class="bi bi-file-earmark-pdf"></i> Generate Official Report
                </button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <!-- Sub Navigation Tabs -->
            <div class="sub-nav-tabs">
                <div class="sub-nav-tab active" data-sub-tab="school-details">
                    <span>School Details</span>
                </div>
                <div class="sub-nav-tab" data-sub-tab="meals-details">
                    <span>Meals Details</span>
                </div>
                <div class="sub-nav-tab" data-sub-tab="fund-details">
                    <span>Fund Details</span>
                </div>
                <div class="sub-nav-tab" data-sub-tab="health-details">
                    <span>Health Details</span>
                </div>
                <div class="sub-nav-tab" data-sub-tab="commodity-rates">
                    <span>Commodity Rates</span>
                </div>
                <div class="sub-nav-tab" data-sub-tab="data-mgmt">
                    <span>Data Management</span>
                </div>
            </div>

            <!-- School Details Sub Tab -->
            <div class="sub-tab-content active" id="school-details">
                <div class="dashboard-card">
                    <h3 class="mb-3">School Details</h3>
                    
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="settings-school-name">School Name</label>
                            <input type="text" id="settings-school-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="settings-udise">UDISE Code</label>
                            <input type="text" id="settings-udise" class="form-control" maxlength="11" pattern="[0-9]{11}">
                        </div>
                        <div class="form-group">
                            <label for="settings-school-type">School Type</label>
                            <select id="settings-school-type" class="form-control">
                                <option value="government">Government</option>
                                <option value="private">Private</option>
                                <option value="government-aided">Government Aided</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="settings-school-category">School Category</label>
                            <select id="settings-school-category" class="form-control">
                                <option value="primary">Primary</option>
                                <option value="upper-primary">Upper Primary</option>
                                <option value="secondary">Secondary</option>
                                <option value="composite">Composite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="settings-kitchen-type">Kitchen Type</label>
                            <select id="settings-kitchen-type" class="form-control">
                                <option value="centralized">Centralized</option>
                                <option value="local">Local</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="settings-state">State/UT</label>
                            <input type="text" id="settings-state" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="settings-district">District</label>
                            <input type="text" id="settings-district" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="settings-block">Block/NP</label>
                            <input type="text" id="settings-block" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="settings-village">Village/Ward</label>
                            <input type="text" id="settings-village" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="settings-ngo">NGO/SHG (Optional)</label>
                            <input type="text" id="settings-ngo" class="form-control">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>On-Roll Student Count</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-balvatika-roll">Balvatika</label>
                                <input type="number" id="settings-balvatika-roll" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-primary-roll">Primary</label>
                                <input type="number" id="settings-primary-roll" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-middle-roll">Middle</label>
                                <input type="number" id="settings-middle-roll" min="0" class="form-control">
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary-custom mt-2" id="settings-school-details-save-btn">
                        <i class="bi bi-save"></i> Save School Details
                    </button>
                </div>
            </div>

            <!-- Meals Details Sub Tab -->
            <div class="sub-tab-content" id="meals-details">
                <div class="dashboard-card">
                    <h3 class="mb-3">Meals Details</h3>
                    
                    <div class="form-group">
                        <label for="meals-month">Select Month</label>
                        <select id="meals-month" class="form-control">
                            <option value="">-- Select Month --</option>
                        </select>
                    </div>

                    <button class="btn-primary-custom mb-3" id="meals-calculate-btn">
                        <i class="bi bi-calculator"></i> Calculate Meals Details
                    </button>

                    <div class="settings-section">
                        <h3>Number of School Days in Month</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="meals-balvatika-school-days">Balvatika</label>
                                <input type="number" id="meals-balvatika-school-days" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-primary-school-days">Primary</label>
                                <input type="number" id="meals-primary-school-days" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-middle-school-days">Middle</label>
                                <input type="number" id="meals-middle-school-days" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-total-school-days">Total</label>
                                <input type="number" id="meals-total-school-days" min="0" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Number of MDM Served Days</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="meals-balvatika-served">Balvatika</label>
                                <input type="number" id="meals-balvatika-served" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-primary-served">Primary</label>
                                <input type="number" id="meals-primary-served" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-middle-served">Middle</label>
                                <input type="number" id="meals-middle-served" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-total-served">Total</label>
                                <input type="number" id="meals-total-served" min="0" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Total Meals Served</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="meals-balvatika-total">Balvatika</label>
                                <input type="number" id="meals-balvatika-total" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-primary-total">Primary</label>
                                <input type="number" id="meals-primary-total" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-middle-total">Middle</label>
                                <input type="number" id="meals-middle-total" min="0" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="meals-total-total">Total</label>
                                <input type="number" id="meals-total-total" min="0" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fund Details Sub Tab -->
            <div class="sub-tab-content" id="fund-details">
                <div class="dashboard-card">
                    <h3 class="mb-3">Fund Details</h3>
                    
                    <div class="form-group">
                        <label for="fund-month">Select Month</label>
                        <select id="fund-month" class="form-control">
                            <option value="">-- Select Month --</option>
                        </select>
                    </div>

                    <button class="btn-primary-custom mb-3" id="fund-calculate-btn">
                        <i class="bi bi-calculator"></i> Calculate Fund Details
                    </button>

                    <div class="settings-section">
                        <h3>Fund Opening Balance (₹)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="fund-balvatika-opening">Balvatika</label>
                                <input type="number" id="fund-balvatika-opening" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-primary-opening">Primary</label>
                                <input type="number" id="fund-primary-opening" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-middle-opening">Middle</label>
                                <input type="number" id="fund-middle-opening" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-total-opening">Total</label>
                                <input type="number" id="fund-total-opening" min="0" step="0.01" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Fund Received (₹)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="fund-balvatika-received">Balvatika</label>
                                <input type="number" id="fund-balvatika-received" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-primary-received">Primary</label>
                                <input type="number" id="fund-primary-received" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-middle-received">Middle</label>
                                <input type="number" id="fund-middle-received" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-total-received">Total</label>
                                <input type="number" id="fund-total-received" min="0" step="0.01" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Fund Expenditure (₹)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="fund-balvatika-expenditure">Balvatika</label>
                                <input type="number" id="fund-balvatika-expenditure" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-primary-expenditure">Primary</label>
                                <input type="number" id="fund-primary-expenditure" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-middle-expenditure">Middle</label>
                                <input type="number" id="fund-middle-expenditure" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-total-expenditure">Total</label>
                                <input type="number" id="fund-total-expenditure" min="0" step="0.01" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Fund Closing Balance (₹)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="fund-balvatika-closing">Balvatika</label>
                                <input type="number" id="fund-balvatika-closing" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-primary-closing">Primary</label>
                                <input type="number" id="fund-primary-closing" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-middle-closing">Middle</label>
                                <input type="number" id="fund-middle-closing" min="0" step="0.01" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fund-total-closing">Total</label>
                                <input type="number" id="fund-total-closing" min="0" step="0.01" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Details Sub Tab -->
            <div class="sub-tab-content" id="health-details">
                <div class="dashboard-card">
                    <h3 class="mb-3">Health Details</h3>
                    
                    <div class="settings-section">
                        <h3>IFA Tablet Beneficiaries</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="health-ifa-boys">Boys</label>
                                <input type="number" id="health-ifa-boys" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="health-ifa-girls">Girls</label>
                                <input type="number" id="health-ifa-girls" min="0" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Health Screening and Referrals</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="health-screened">Screened by RBSK Team</label>
                                <input type="number" id="health-screened" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="health-referred">Referred by RBSK Team</label>
                                <input type="number" id="health-referred" min="0" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Inspection Report</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="health-inspection-done">Inspection Done This Month</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="health-inspection-done">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="health-incidents">Number of Untoward Incidents</label>
                                <input type="number" id="health-incidents" min="0" class="form-control">
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary-custom mt-2" id="settings-health-details-save-btn">
                        <i class="bi bi-save"></i> Save Health Details
                    </button>
                </div>
            </div>

            <!-- Commodity Rates Sub Tab -->
            <div class="sub-tab-content" id="commodity-rates">
                <div class="dashboard-card">
                    <h3 class="mb-3">Commodity Rates</h3>
                    
                    <div class="note-box">
                        <i class="bi bi-exclamation-triangle"></i> Changes affect only future calculations, not past entries.
                    </div>
                    
                    <div class="settings-section">
                        <h3>Rice (grams per student)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-rice-balvatika">Balvatika</label>
                                <input type="number" id="settings-rice-balvatika" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-rice-primary">Primary</label>
                                <input type="number" id="settings-rice-primary" min="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-rice-middle">Middle</label>
                                <input type="number" id="settings-rice-middle" min="0" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Dal & Vegetables (₹ per student)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-dal-balvatika">Balvatika</label>
                                <input type="number" id="settings-dal-balvatika" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-dal-primary">Primary</label>
                                <input type="number" id="settings-dal-primary" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-dal-middle">Middle</label>
                                <input type="number" id="settings-dal-middle" min="0" step="0.01" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Oil & Condiments (₹ per student)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-oil-balvatika">Balvatika</label>
                                <input type="number" id="settings-oil-balvatika" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-oil-primary">Primary</label>
                                <input type="number" id="settings-oil-primary" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-oil-middle">Middle</label>
                                <input type="number" id="settings-oil-middle" min="0" step="0.01" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Salt (₹ per student)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-salt-balvatika">Balvatika</label>
                                <input type="number" id="settings-salt-balvatika" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-salt-primary">Primary</label>
                                <input type="number" id="settings-salt-primary" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-salt-middle">Middle</label>
                                <input type="number" id="settings-salt-middle" min="0" step="0.01" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Fuel (₹ per student)</h3>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="settings-fuel-balvatika">Balvatika</label>
                                <input type="number" id="settings-fuel-balvatika" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-fuel-primary">Primary</label>
                                <input type="number" id="settings-fuel-primary" min="0" step="0.01" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="settings-fuel-middle">Middle</label>
                                <input type="number" id="settings-fuel-middle" min="0" step="0.01" class="form-control">
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary-custom mt-2" id="settings-rates-save-btn">
                        <i class="bi bi-save"></i> Save Commodity Rates
                    </button>
                </div>
            </div>

            <!-- Data Management Sub Tab -->
            <div class="sub-tab-content" id="data-mgmt">
                <div class="dashboard-card">
                    <h3 class="mb-3">Data Management</h3>
                    
                    <div class="action-buttons">
                        <button class="btn-success-custom" id="settings-backup-btn">
                            <i class="bi bi-download"></i> Backup Data
                        </button>
                        
                        <button class="btn-secondary-custom" id="settings-restore-btn">
                            <i class="bi bi-upload"></i> Restore Data
                        </button>
                    </div>
                    
                    <input type="file" id="settings-restore-file" style="display: none;" accept=".json">
                    
                    <div class="action-buttons mt-2">
                        <button class="btn-danger-custom" id="settings-reset-btn">
                            <i class="bi bi-trash"></i> Reset All Data
                        </button>
                        
                        <button class="btn-primary-custom" id="settings-save-all-btn">
                            <i class="bi bi-save"></i> Save All Settings
                        </button>
                    </div>
                    
                    <button class="btn-primary-custom mt-3" id="settings-back-to-dashboard-btn">
                        <i class="bi bi-speedometer2"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- App Footer -->
        <div class="app-footer">
            Developed by Imran Gani | Teacher Zone Vailoo
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmationModalConfirm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // DOM Elements
        const UI = {
            // Navigation
            navTabs: document.querySelectorAll('.nav-tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            subNavTabs: document.querySelectorAll('.sub-nav-tab'),
            subTabContents: document.querySelectorAll('.sub-tab-content'),
            
            // Dashboard
            dashboardSchoolName: document.getElementById('dashboard-school-name'),
            dashboardUdise: document.getElementById('dashboard-udise'),
            dashboardDate: document.getElementById('dashboard-date'),
            dashboardExpenditure: document.getElementById('dashboard-expenditure'),
            dashboardRice: document.getElementById('dashboard-rice'),
            dashboardStudents: document.getElementById('dashboard-students'),
            dashboardBalvatika: document.getElementById('dashboard-balvatika'),
            dashboardPrimary: document.getElementById('dashboard-primary'),
            dashboardMiddle: document.getElementById('dashboard-middle'),
            dashboardSaveBtn: document.getElementById('dashboard-save-btn'),
            
            // Summary
            summaryMonth: document.getElementById('summary-month'),
            summaryCategory: document.getElementById('summary-category'),
            summaryGenerateBtn: document.getElementById('summary-generate-btn'),
            summaryTable: document.getElementById('summary-table'),
            
            // Summary - Rice Entry
            summaryRiceDate: document.getElementById('summary-rice-date'),
            summaryRiceBalvatika: document.getElementById('summary-rice-balvatika'),
            summaryRicePrimary: document.getElementById('summary-rice-primary'),
            summaryRiceMiddle: document.getElementById('summary-rice-middle'),
            summaryRiceTotal: document.getElementById('summary-rice-total'),
            summaryRiceSaveBtn: document.getElementById('summary-rice-save-btn'),
            
            // Summary - Cash Entry
            summaryCashDate: document.getElementById('summary-cash-date'),
            summaryCashBalvatika: document.getElementById('summary-cash-balvatika'),
            summaryCashPrimary: document.getElementById('summary-cash-primary'),
            summaryCashMiddle: document.getElementById('summary-cash-middle'),
            summaryCashTotal: document.getElementById('summary-cash-total'),
            summaryCashSaveBtn: document.getElementById('summary-cash-save-btn'),
            
            // Abstracts
            abstractsMonth: document.getElementById('abstracts-month'),
            abstractsGenerateBtn: document.getElementById('abstracts-generate-btn'),
            
            // Abstracts - Rice
            riceBalvatikaOpening: document.getElementById('rice-balvatika-opening'),
            riceBalvatikaReceived: document.getElementById('rice-balvatika-received'),
            riceBalvatikaConsumed: document.getElementById('rice-balvatika-consumed'),
            riceBalvatikaBalance: document.getElementById('rice-balvatika-balance'),
            ricePrimaryOpening: document.getElementById('rice-primary-opening'),
            ricePrimaryReceived: document.getElementById('rice-primary-received'),
            ricePrimaryConsumed: document.getElementById('rice-primary-consumed'),
            ricePrimaryBalance: document.getElementById('rice-primary-balance'),
            riceMiddleOpening: document.getElementById('rice-middle-opening'),
            riceMiddleReceived: document.getElementById('rice-middle-received'),
            riceMiddleConsumed: document.getElementById('rice-middle-consumed'),
            riceMiddleBalance: document.getElementById('rice-middle-balance'),
            riceTotalOpening: document.getElementById('rice-total-opening'),
            riceTotalReceived: document.getElementById('rice-total-received'),
            riceTotalConsumed: document.getElementById('rice-total-consumed'),
            riceTotalBalance: document.getElementById('rice-total-balance'),
            
            // Abstracts - Cash
            cashBalvatikaOpening: document.getElementById('cash-balvatika-opening'),
            cashBalvatikaReceived: document.getElementById('cash-balvatika-received'),
            cashBalvatikaExpenditure: document.getElementById('cash-balvatika-expenditure'),
            cashBalvatikaBalance: document.getElementById('cash-balvatika-balance'),
            cashPrimaryOpening: document.getElementById('cash-primary-opening'),
            cashPrimaryReceived: document.getElementById('cash-primary-received'),
            cashPrimaryExpenditure: document.getElementById('cash-primary-expenditure'),
            cashPrimaryBalance: document.getElementById('cash-primary-balance'),
            cashMiddleOpening: document.getElementById('cash-middle-opening'),
            cashMiddleReceived: document.getElementById('cash-middle-received'),
            cashMiddleExpenditure: document.getElementById('cash-middle-expenditure'),
            cashMiddleBalance: document.getElementById('cash-middle-balance'),
            cashTotalOpening: document.getElementById('cash-total-opening'),
            cashTotalReceived: document.getElementById('cash-total-received'),
            cashTotalExpenditure: document.getElementById('cash-total-expenditure'),
            cashTotalBalance: document.getElementById('cash-total-balance'),
            
            // Export
            exportMonth: document.getElementById('export-month'),
            exportGenerateBtn: document.getElementById('export-generate-btn'),
            exportValidationMessage: document.getElementById('export-validation-message'),
            exportProgressContainer: document.getElementById('export-progress-container'),
            exportProgressBar: document.getElementById('export-progress-bar'),
            exportProgressText: document.getElementById('export-progress-text'),
            
            // Settings - School Details
            settingsSchoolName: document.getElementById('settings-school-name'),
            settingsUdise: document.getElementById('settings-udise'),
            settingsSchoolType: document.getElementById('settings-school-type'),
            settingsSchoolCategory: document.getElementById('settings-school-category'),
            settingsKitchenType: document.getElementById('settings-kitchen-type'),
            settingsState: document.getElementById('settings-state'),
            settingsDistrict: document.getElementById('settings-district'),
            settingsBlock: document.getElementById('settings-block'),
            settingsVillage: document.getElementById('settings-village'),
            settingsNgo: document.getElementById('settings-ngo'),
            settingsBalvatikaRoll: document.getElementById('settings-balvatika-roll'),
            settingsPrimaryRoll: document.getElementById('settings-primary-roll'),
            settingsMiddleRoll: document.getElementById('settings-middle-roll'),
            settingsSchoolDetailsSaveBtn: document.getElementById('settings-school-details-save-btn'),
            
            // Settings - Meals Details
            mealsMonth: document.getElementById('meals-month'),
            mealsBalvatikaSchoolDays: document.getElementById('meals-balvatika-school-days'),
            mealsPrimarySchoolDays: document.getElementById('meals-primary-school-days'),
            mealsMiddleSchoolDays: document.getElementById('meals-middle-school-days'),
            mealsTotalSchoolDays: document.getElementById('meals-total-school-days'),
            mealsBalvatikaServed: document.getElementById('meals-balvatika-served'),
            mealsPrimaryServed: document.getElementById('meals-primary-served'),
            mealsMiddleServed: document.getElementById('meals-middle-served'),
            mealsTotalServed: document.getElementById('meals-total-served'),
            mealsBalvatikaTotal: document.getElementById('meals-balvatika-total'),
            mealsPrimaryTotal: document.getElementById('meals-primary-total'),
            mealsMiddleTotal: document.getElementById('meals-middle-total'),
            mealsTotalTotal: document.getElementById('meals-total-total'),
            mealsCalculateBtn: document.getElementById('meals-calculate-btn'),
            
            // Settings - Fund Details
            fundMonth: document.getElementById('fund-month'),
            fundBalvatikaOpening: document.getElementById('fund-balvatika-opening'),
            fundPrimaryOpening: document.getElementById('fund-primary-opening'),
            fundMiddleOpening: document.getElementById('fund-middle-opening'),
            fundTotalOpening: document.getElementById('fund-total-opening'),
            fundBalvatikaReceived: document.getElementById('fund-balvatika-received'),
            fundPrimaryReceived: document.getElementById('fund-primary-received'),
            fundMiddleReceived: document.getElementById('fund-middle-received'),
            fundTotalReceived: document.getElementById('fund-total-received'),
            fundBalvatikaExpenditure: document.getElementById('fund-balvatika-expenditure'),
            fundPrimaryExpenditure: document.getElementById('fund-primary-expenditure'),
            fundMiddleExpenditure: document.getElementById('fund-middle-expenditure'),
            fundTotalExpenditure: document.getElementById('fund-total-expenditure'),
            fundBalvatikaClosing: document.getElementById('fund-balvatika-closing'),
            fundPrimaryClosing: document.getElementById('fund-primary-closing'),
            fundMiddleClosing: document.getElementById('fund-middle-closing'),
            fundTotalClosing: document.getElementById('fund-total-closing'),
            fundCalculateBtn: document.getElementById('fund-calculate-btn'),
            
            // Settings - Health Details
            healthIfaBoys: document.getElementById('health-ifa-boys'),
            healthIfaGirls: document.getElementById('health-ifa-girls'),
            healthScreened: document.getElementById('health-screened'),
            healthReferred: document.getElementById('health-referred'),
            healthInspectionDone: document.getElementById('health-inspection-done'),
            healthIncidents: document.getElementById('health-incidents'),
            settingsHealthDetailsSaveBtn: document.getElementById('settings-health-details-save-btn'),
            
            // Settings - Commodity Rates
            settingsRiceBalvatika: document.getElementById('settings-rice-balvatika'),
            settingsRicePrimary: document.getElementById('settings-rice-primary'),
            settingsRiceMiddle: document.getElementById('settings-rice-middle'),
            settingsDalBalvatika: document.getElementById('settings-dal-balvatika'),
            settingsDalPrimary: document.getElementById('settings-dal-primary'),
            settingsDalMiddle: document.getElementById('settings-dal-middle'),
            settingsOilBalvatika: document.getElementById('settings-oil-balvatika'),
            settingsOilPrimary: document.getElementById('settings-oil-primary'),
            settingsOilMiddle: document.getElementById('settings-oil-middle'),
            settingsSaltBalvatika: document.getElementById('settings-salt-balvatika'),
            settingsSaltPrimary: document.getElementById('settings-salt-primary'),
            settingsSaltMiddle: document.getElementById('settings-salt-middle'),
            settingsFuelBalvatika: document.getElementById('settings-fuel-balvatika'),
            settingsFuelPrimary: document.getElementById('settings-fuel-primary'),
            settingsFuelMiddle: document.getElementById('settings-fuel-middle'),
            settingsRatesSaveBtn: document.getElementById('settings-rates-save-btn'),
            
            // Settings - Data Management
            settingsBackupBtn: document.getElementById('settings-backup-btn'),
            settingsRestoreBtn: document.getElementById('settings-restore-btn'),
            settingsRestoreFile: document.getElementById('settings-restore-file'),
            settingsResetBtn: document.getElementById('settings-reset-btn'),
            settingsSaveAllBtn: document.getElementById('settings-save-all-btn'),
            settingsBackToDashboardBtn: document.getElementById('settings-back-to-dashboard-btn'),
            
            // Modals
            confirmationModal: new bootstrap.Modal(document.getElementById('confirmationModal')),
            confirmationModalTitle: document.getElementById('confirmationModalTitle'),
            confirmationModalBody: document.getElementById('confirmationModalBody'),
            confirmationModalConfirm: document.getElementById('confirmationModalConfirm'),
            
            // Toast
            toastContainer: document.querySelector('.toast-container')
        };

        // App State
        const state = {
            entries: [],
            riceEntries: [],
            cashEntries: [],
            settings: {
                schoolName: 'Middle School Senzi',
                udise: '01061600204',
                onRoll: {
                    balvatika: 0,
                    primary: 0,
                    middle: 0
                },
                rates: {
                    rice: {
                        balvatika: 100,
                        primary: 100,
                        middle: 150
                    },
                    dal: {
                        balvatika: 3.50,
                        primary: 3.50,
                        middle: 5.40
                    },
                    oil: {
                        balvatika: 1.10,
                        primary: 1.10,
                        middle: 2.00
                    },
                    salt: {
                        balvatika: 0.80,
                        primary: 0.80,
                        middle: 1.00
                    },
                    fuel: {
                        balvatika: 1.38,
                        primary: 1.38,
                        middle: 1.77
                    }
                },
                balances: {
                    rice: 0,
                    cash: 0
                },
                schoolDetails: {
                    schoolType: 'government',
                    schoolCategory: 'primary',
                    kitchenType: 'local',
                    state: '',
                    district: '',
                    block: '',
                    village: '',
                    ngo: ''
                },
                healthDetails: {
                    ifaBoys: 0,
                    ifaGirls: 0,
                    screened: 0,
                    referred: 0,
                    inspectionDone: false,
                    incidents: 0
                }
            },
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear()
        };

        // Initialize App
        function init() {
            // Load data from localStorage
            loadData();
            
            // Set current date
            const today = new Date();
            UI.summaryRiceDate.value = formatDate(today);
            UI.summaryCashDate.value = formatDate(today);
            
            // Update dashboard date
            UI.dashboardDate.textContent = formatDate(today, true);
            
            // Populate month dropdowns
            populateMonthDropdowns();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update UI with settings
            updateUIWithSettings();
            
            // Update dashboard
            updateDashboard();
            
            // Create attendance chart
            createAttendanceChart();
        }

        // Format date for input fields
        function formatDate(date, display = false) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            if (display) {
                return `${day}-${month}-${year}`;
            }
            
            return `${year}-${month}-${day}`;
        }

        // Load data from localStorage
        function loadData() {
            const savedEntries = localStorage.getItem('poshanEntries');
            const savedRiceEntries = localStorage.getItem('poshanRiceEntries');
            const savedCashEntries = localStorage.getItem('poshanCashEntries');
            const savedSettings = localStorage.getItem('poshanSettings');
            
            if (savedEntries) {
                state.entries = JSON.parse(savedEntries);
            }
            
            if (savedRiceEntries) {
                state.riceEntries = JSON.parse(savedRiceEntries);
            }
            
            if (savedCashEntries) {
                state.cashEntries = JSON.parse(savedCashEntries);
            }
            
            if (savedSettings) {
                state.settings = JSON.parse(savedSettings);
                
                // Ensure schoolDetails exists
                if (!state.settings.schoolDetails) {
                    state.settings.schoolDetails = {
                        schoolType: 'government',
                        schoolCategory: 'primary',
                        kitchenType: 'local',
                        state: '',
                        district: '',
                        block: '',
                        village: '',
                        ngo: ''
                    };
                }
                
                // Ensure healthDetails exists
                if (!state.settings.healthDetails) {
                    state.settings.healthDetails = {
                        ifaBoys: 0,
                        ifaGirls: 0,
                        screened: 0,
                        referred: 0,
                        inspectionDone: false,
                        incidents: 0
                    };
                }
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('poshanEntries', JSON.stringify(state.entries));
            localStorage.setItem('poshanRiceEntries', JSON.stringify(state.riceEntries));
            localStorage.setItem('poshanCashEntries', JSON.stringify(state.cashEntries));
            localStorage.setItem('poshanSettings', JSON.stringify(state.settings));
        }

        // Populate month dropdowns
        function populateMonthDropdowns() {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            
            // Populate for current year and previous year
            for (let year = currentYear - 1; year <= currentYear; year++) {
                for (let i = 0; i < 12; i++) {
                    if (year === currentYear && i > currentMonth) continue;
                    
                    const value = `${year}-${String(i + 1).padStart(2, '0')}`;
                    const text = `${months[i]} ${year}`;
                    
                    const option1 = new Option(text, value);
                    const option2 = new Option(text, value);
                    const option3 = new Option(text, value);
                    const option4 = new Option(text, value);
                    const option5 = new Option(text, value);
                    
                    UI.summaryMonth.add(option1);
                    UI.abstractsMonth.add(option2);
                    UI.mealsMonth.add(option3);
                    UI.fundMonth.add(option4);
                    UI.exportMonth.add(option5);
                    
                    // Set current month as default
                    if (year === currentYear && i === currentMonth) {
                        UI.summaryMonth.value = value;
                        UI.abstractsMonth.value = value;
                        UI.mealsMonth.value = value;
                        UI.fundMonth.value = value;
                        UI.exportMonth.value = value;
                    }
                }
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation tabs
            UI.navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Sub navigation tabs
            UI.subNavTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const subTabId = tab.getAttribute('data-sub-tab');
                    switchSubTab(subTabId);
                });
            });
            
            // Dashboard entry inputs
            UI.dashboardBalvatika.addEventListener('input', updateDashboardCalculations);
            UI.dashboardPrimary.addEventListener('input', updateDashboardCalculations);
            UI.dashboardMiddle.addEventListener('input', updateDashboardCalculations);
            
            // Summary rice entry inputs
            UI.summaryRiceBalvatika.addEventListener('input', updateSummaryRiceCalculations);
            UI.summaryRicePrimary.addEventListener('input', updateSummaryRiceCalculations);
            UI.summaryRiceMiddle.addEventListener('input', updateSummaryRiceCalculations);
            
            // Summary cash entry inputs
            UI.summaryCashBalvatika.addEventListener('input', updateSummaryCashCalculations);
            UI.summaryCashPrimary.addEventListener('input', updateSummaryCashCalculations);
            UI.summaryCashMiddle.addEventListener('input', updateSummaryCashCalculations);
            
            // Save buttons
            UI.dashboardSaveBtn.addEventListener('click', saveDashboardEntry);
            UI.summaryRiceSaveBtn.addEventListener('click', saveSummaryRiceEntry);
            UI.summaryCashSaveBtn.addEventListener('click', saveSummaryCashEntry);
            
            // Settings save buttons
            UI.settingsSchoolDetailsSaveBtn.addEventListener('click', saveSchoolDetails);
            UI.settingsRatesSaveBtn.addEventListener('click', saveCommodityRates);
            UI.settingsHealthDetailsSaveBtn.addEventListener('click', saveHealthDetails);
            UI.settingsSaveAllBtn.addEventListener('click', saveAllSettings);
            UI.settingsBackToDashboardBtn.addEventListener('click', () => switchTab('dashboard'));
            
            // Summary
            UI.summaryGenerateBtn.addEventListener('click', generateSummary);
            
            // Abstracts
            UI.abstractsGenerateBtn.addEventListener('click', generateAbstracts);
            
            // Export
            UI.exportGenerateBtn.addEventListener('click', generateOfficialMDCFReport);
            
            // Meals Details
            UI.mealsCalculateBtn.addEventListener('click', calculateMealsDetails);
            
            // Fund Details
            UI.fundCalculateBtn.addEventListener('click', calculateFundDetails);
            
            // Data management
            UI.settingsBackupBtn.addEventListener('click', backupData);
            UI.settingsRestoreBtn.addEventListener('click', () => {
                UI.settingsRestoreFile.click();
            });
            UI.settingsRestoreFile.addEventListener('change', restoreData);
            UI.settingsResetBtn.addEventListener('click', resetData);
        }

        // Switch tab
        function switchTab(tabId) {
            // Hide all tab contents
            UI.tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            UI.navTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to corresponding nav tab
            const correspondingNavTab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
            if (correspondingNavTab) {
                correspondingNavTab.classList.add('active');
            }
        }

        // Switch sub tab
        function switchSubTab(subTabId) {
            // Hide all sub tab contents
            UI.subTabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all sub nav tabs
            UI.subNavTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected sub tab content
            const selectedSubTab = document.getElementById(subTabId);
            if (selectedSubTab) {
                selectedSubTab.classList.add('active');
            }
            
            // Add active class to corresponding sub nav tab
            const correspondingSubNavTab = document.querySelector(`.sub-nav-tab[data-sub-tab="${subTabId}"]`);
            if (correspondingSubNavTab) {
                correspondingSubNavTab.classList.add('active');
            }
        }

        // Update dashboard calculations
        function updateDashboardCalculations() {
            const balvatika = parseInt(UI.dashboardBalvatika.value) || 0;
            const primary = parseInt(UI.dashboardPrimary.value) || 0;
            const middle = parseInt(UI.dashboardMiddle.value) || 0;
            
            const totalStudents = balvatika + primary + middle;
            
            // Calculate rice consumption
            const riceBalvatika = (balvatika * state.settings.rates.rice.balvatika) / 1000;
            const ricePrimary = (primary * state.settings.rates.rice.primary) / 1000;
            const riceMiddle = (middle * state.settings.rates.rice.middle) / 1000;
            const totalRice = riceBalvatika + ricePrimary + riceMiddle;
            
            // Calculate expenditure
            const dalBalvatika = balvatika * state.settings.rates.dal.balvatika;
            const dalPrimary = primary * state.settings.rates.dal.primary;
            const dalMiddle = middle * state.settings.rates.dal.middle;
            
            const oilBalvatika = balvatika * state.settings.rates.oil.balvatika;
            const oilPrimary = primary * state.settings.rates.oil.primary;
            const oilMiddle = middle * state.settings.rates.oil.middle;
            
            const saltBalvatika = balvatika * state.settings.rates.salt.balvatika;
            const saltPrimary = primary * state.settings.rates.salt.primary;
            const saltMiddle = middle * state.settings.rates.salt.middle;
            
            const fuelBalvatika = balvatika * state.settings.rates.fuel.balvatika;
            const fuelPrimary = primary * state.settings.rates.fuel.primary;
            const fuelMiddle = middle * state.settings.rates.fuel.middle;
            
            const totalExpenditure = dalBalvatika + dalPrimary + dalMiddle +
                                    oilBalvatika + oilPrimary + oilMiddle +
                                    saltBalvatika + saltPrimary + saltMiddle +
                                    fuelBalvatika + fuelPrimary + fuelMiddle;
            
            // Update UI
            UI.dashboardStudents.textContent = totalStudents;
            UI.dashboardRice.textContent = `${totalRice.toFixed(2)} kg`;
            UI.dashboardExpenditure.textContent = `₹${totalExpenditure.toFixed(2)}`;
        }

        // Update summary rice calculations
        function updateSummaryRiceCalculations() {
            const balvatika = parseFloat(UI.summaryRiceBalvatika.value) || 0;
            const primary = parseFloat(UI.summaryRicePrimary.value) || 0;
            const middle = parseFloat(UI.summaryRiceMiddle.value) || 0;
            
            const totalRice = balvatika + primary + middle;
            UI.summaryRiceTotal.value = totalRice.toFixed(2);
        }

        // Update summary cash calculations
        function updateSummaryCashCalculations() {
            const balvatika = parseFloat(UI.summaryCashBalvatika.value) || 0;
            const primary = parseFloat(UI.summaryCashPrimary.value) || 0;
            const middle = parseFloat(UI.summaryCashMiddle.value) || 0;
            
            const totalCash = balvatika + primary + middle;
            UI.summaryCashTotal.value = totalCash.toFixed(2);
        }

        // Save dashboard entry
        function saveDashboardEntry() {
            const date = new Date().toISOString().split('T')[0];
            const balvatika = parseInt(UI.dashboardBalvatika.value) || 0;
            const primary = parseInt(UI.dashboardPrimary.value) || 0;
            const middle = parseInt(UI.dashboardMiddle.value) || 0;
            
            if (balvatika === 0 && primary === 0 && middle === 0) {
                showToast('Please enter at least one student count', 'warning');
                return;
            }
            
            // Check if entry already exists for this date
            const existingEntryIndex = state.entries.findIndex(entry => entry.date === date);
            
            if (existingEntryIndex !== -1) {
                // Show confirmation modal
                UI.confirmationModalTitle.textContent = 'Overwrite Entry';
                UI.confirmationModalBody.textContent = `An entry already exists for ${formatDate(new Date(date), true)}. Do you want to overwrite it?`;
                
                UI.confirmationModalConfirm.onclick = () => {
                    // Update existing entry
                    saveEntryData(date, balvatika, primary, middle, existingEntryIndex);
                    UI.confirmationModal.hide();
                };
                
                UI.confirmationModal.show();
            } else {
                // Save new entry
                saveEntryData(date, balvatika, primary, middle);
            }
        }

        // Save entry data
        function saveEntryData(date, balvatika, primary, middle, existingIndex = -1) {
            // Calculate rice consumption
            const riceBalvatika = (balvatika * state.settings.rates.rice.balvatika) / 1000;
            const ricePrimary = (primary * state.settings.rates.rice.primary) / 1000;
            const riceMiddle = (middle * state.settings.rates.rice.middle) / 1000;
            const totalRice = riceBalvatika + ricePrimary + riceMiddle;
            
            // Calculate expenditure
            const dalBalvatika = balvatika * state.settings.rates.dal.balvatika;
            const dalPrimary = primary * state.settings.rates.dal.primary;
            const dalMiddle = middle * state.settings.rates.dal.middle;
            const totalDal = dalBalvatika + dalPrimary + dalMiddle;
            
            const oilBalvatika = balvatika * state.settings.rates.oil.balvatika;
            const oilPrimary = primary * state.settings.rates.oil.primary;
            const oilMiddle = middle * state.settings.rates.oil.middle;
            const totalOil = oilBalvatika + oilPrimary + oilMiddle;
            
            const saltBalvatika = balvatika * state.settings.rates.salt.balvatika;
            const saltPrimary = primary * state.settings.rates.salt.primary;
            const saltMiddle = middle * state.settings.rates.salt.middle;
            const totalSalt = saltBalvatika + saltPrimary + saltMiddle;
            
            const fuelBalvatika = balvatika * state.settings.rates.fuel.balvatika;
            const fuelPrimary = primary * state.settings.rates.fuel.primary;
            const fuelMiddle = middle * state.settings.rates.fuel.middle;
            const totalFuel = fuelBalvatika + fuelPrimary + fuelMiddle;
            
            const totalExpenditure = totalDal + totalOil + totalSalt + totalFuel;
            
            const entryData = {
                date,
                balvatika,
                primary,
                middle,
                totalStudents: balvatika + primary + middle,
                rice: totalRice,
                dal: totalDal,
                oil: totalOil,
                salt: totalSalt,
                fuel: totalFuel,
                total: totalExpenditure
            };
            
            if (existingIndex !== -1) {
                // Update existing entry
                state.entries[existingIndex] = entryData;
                showToast('Entry updated successfully', 'success');
            } else {
                // Add new entry
                state.entries.push(entryData);
                showToast('Entry saved successfully', 'success');
            }
            
            // Sort entries by date
            state.entries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Save to localStorage
            saveData();
            
            // Update dashboard
            updateDashboard();
            
            // Reset form
            UI.dashboardBalvatika.value = '';
            UI.dashboardPrimary.value = '';
            UI.dashboardMiddle.value = '';
            updateDashboardCalculations();
        }

        // Save summary rice entry
        function saveSummaryRiceEntry() {
            const date = UI.summaryRiceDate.value;
            const balvatika = parseFloat(UI.summaryRiceBalvatika.value) || 0;
            const primary = parseFloat(UI.summaryRicePrimary.value) || 0;
            const middle = parseFloat(UI.summaryRiceMiddle.value) || 0;
            
            if (!date) {
                showToast('Please select a date', 'warning');
                return;
            }
            
            if (balvatika === 0 && primary === 0 && middle === 0) {
                showToast('Please enter at least one rice amount', 'warning');
                return;
            }
            
            const totalRice = balvatika + primary + middle;
            
            // Check if entry already exists for this date
            const existingEntryIndex = state.riceEntries.findIndex(entry => entry.date === date);
            
            const entryData = {
                date,
                balvatika,
                primary,
                middle,
                total: totalRice
            };
            
            if (existingEntryIndex !== -1) {
                // Update existing entry
                state.riceEntries[existingEntryIndex] = entryData;
                showToast('Rice entry updated successfully', 'success');
            } else {
                // Add new entry
                state.riceEntries.push(entryData);
                showToast('Rice entry saved successfully', 'success');
            }
            
            // Sort entries by date
            state.riceEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Save to localStorage
            saveData();
            
            // Reset form
            UI.summaryRiceBalvatika.value = '';
            UI.summaryRicePrimary.value = '';
            UI.summaryRiceMiddle.value = '';
            UI.summaryRiceTotal.value = '';
        }

        // Save summary cash entry
        function saveSummaryCashEntry() {
            const date = UI.summaryCashDate.value;
            const balvatika = parseFloat(UI.summaryCashBalvatika.value) || 0;
            const primary = parseFloat(UI.summaryCashPrimary.value) || 0;
            const middle = parseFloat(UI.summaryCashMiddle.value) || 0;
            
            if (!date) {
                showToast('Please select a date', 'warning');
                return;
            }
            
            if (balvatika === 0 && primary === 0 && middle === 0) {
                showToast('Please enter at least one cash amount', 'warning');
                return;
            }
            
            const totalCash = balvatika + primary + middle;
            
            // Check if entry already exists for this date
            const existingEntryIndex = state.cashEntries.findIndex(entry => entry.date === date);
            
            const entryData = {
                date,
                balvatika,
                primary,
                middle,
                total: totalCash
            };
            
            if (existingEntryIndex !== -1) {
                // Update existing entry
                state.cashEntries[existingEntryIndex] = entryData;
                showToast('Cash entry updated successfully', 'success');
            } else {
                // Add new entry
                state.cashEntries.push(entryData);
                showToast('Cash entry saved successfully', 'success');
            }
            
            // Sort entries by date
            state.cashEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Save to localStorage
            saveData();
            
            // Reset form
            UI.summaryCashBalvatika.value = '';
            UI.summaryCashPrimary.value = '';
            UI.summaryCashMiddle.value = '';
            UI.summaryCashTotal.value = '';
        }

        // Save school details
        function saveSchoolDetails() {
            // Validate UDISE code
            const udise = UI.settingsUdise.value.trim();
            if (udise.length !== 11 || !/^\d+$/.test(udise)) {
                showToast('UDISE code must be 11 digits', 'warning');
                return;
            }
            
            // Update settings
            state.settings.schoolName = UI.settingsSchoolName.value.trim();
            state.settings.udise = udise;
            state.settings.schoolDetails.schoolType = UI.settingsSchoolType.value;
            state.settings.schoolDetails.schoolCategory = UI.settingsSchoolCategory.value;
            state.settings.schoolDetails.kitchenType = UI.settingsKitchenType.value;
            state.settings.schoolDetails.state = UI.settingsState.value;
            state.settings.schoolDetails.district = UI.settingsDistrict.value;
            state.settings.schoolDetails.block = UI.settingsBlock.value;
            state.settings.schoolDetails.village = UI.settingsVillage.value;
            state.settings.schoolDetails.ngo = UI.settingsNgo.value;
            state.settings.onRoll.balvatika = parseInt(UI.settingsBalvatikaRoll.value) || 0;
            state.settings.onRoll.primary = parseInt(UI.settingsPrimaryRoll.value) || 0;
            state.settings.onRoll.middle = parseInt(UI.settingsMiddleRoll.value) || 0;
            
            // Save to localStorage
            saveData();
            
            // Update UI
            updateUIWithSettings();
            
            showToast('School details saved successfully', 'success');
        }

        // Save commodity rates
        function saveCommodityRates() {
            // Update settings
            state.settings.rates.rice.balvatika = parseInt(UI.settingsRiceBalvatika.value) || 0;
            state.settings.rates.rice.primary = parseInt(UI.settingsRicePrimary.value) || 0;
            state.settings.rates.rice.middle = parseInt(UI.settingsRiceMiddle.value) || 0;
            
            state.settings.rates.dal.balvatika = parseFloat(UI.settingsDalBalvatika.value) || 0;
            state.settings.rates.dal.primary = parseFloat(UI.settingsDalPrimary.value) || 0;
            state.settings.rates.dal.middle = parseFloat(UI.settingsDalMiddle.value) || 0;
            
            state.settings.rates.oil.balvatika = parseFloat(UI.settingsOilBalvatika.value) || 0;
            state.settings.rates.oil.primary = parseFloat(UI.settingsOilPrimary.value) || 0;
            state.settings.rates.oil.middle = parseFloat(UI.settingsOilMiddle.value) || 0;
            
            state.settings.rates.salt.balvatika = parseFloat(UI.settingsSaltBalvatika.value) || 0;
            state.settings.rates.salt.primary = parseFloat(UI.settingsSaltPrimary.value) || 0;
            state.settings.rates.salt.middle = parseFloat(UI.settingsSaltMiddle.value) || 0;
            
            state.settings.rates.fuel.balvatika = parseFloat(UI.settingsFuelBalvatika.value) || 0;
            state.settings.rates.fuel.primary = parseFloat(UI.settingsFuelPrimary.value) || 0;
            state.settings.rates.fuel.middle = parseFloat(UI.settingsFuelMiddle.value) || 0;
            
            // Save to localStorage
            saveData();
            
            showToast('Commodity rates saved successfully', 'success');
        }

        // Save health details
        function saveHealthDetails() {
            // Update settings
            state.settings.healthDetails.ifaBoys = parseInt(UI.healthIfaBoys.value) || 0;
            state.settings.healthDetails.ifaGirls = parseInt(UI.healthIfaGirls.value) || 0;
            state.settings.healthDetails.screened = parseInt(UI.healthScreened.value) || 0;
            state.settings.healthDetails.referred = parseInt(UI.healthReferred.value) || 0;
            state.settings.healthDetails.inspectionDone = UI.healthInspectionDone.checked;
            state.settings.healthDetails.incidents = parseInt(UI.healthIncidents.value) || 0;
            
            // Save to localStorage
            saveData();
            
            showToast('Health details saved successfully', 'success');
        }

        // Calculate meals details
        function calculateMealsDetails() {
            const monthYear = UI.mealsMonth.value;
            
            if (!monthYear) {
                showToast('Please select a month', 'warning');
                return;
            }
            
            // Parse month and year
            const [year, month] = monthYear.split('-').map(Number);
            
            // Get entries for selected month
            const monthEntries = state.entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Initialize data structure
            const data = {
                balvatika: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                primary: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                middle: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                total: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                }
            };
            
            // Get number of days in month
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Calculate school days (days with any attendance recorded)
            const schoolDaysSet = new Set();
            
            monthEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month - 1) {
                    schoolDaysSet.add(entryDate.getDate());
                    
                    // Calculate total meals
                    data.balvatika.total += entry.balvatika;
                    data.primary.total += entry.primary;
                    data.middle.total += entry.middle;
                    
                    // Calculate served days (days with meal served)
                    if (entry.totalStudents > 0) {
                        if (!data.balvatika.servedDays) data.balvatika.servedDays = new Set();
                        if (!data.primary.servedDays) data.primary.servedDays = new Set();
                        if (!data.middle.servedDays) data.middle.servedDays = new Set();
                        
                        if (entry.balvatika > 0) data.balvatika.servedDays.add(entryDate.getDate());
                        if (entry.primary > 0) data.primary.servedDays.add(entryDate.getDate());
                        if (entry.middle > 0) data.middle.servedDays.add(entryDate.getDate());
                    }
                }
            });
            
            // Set school days
            data.balvatika.schoolDays = schoolDaysSet.size;
            data.primary.schoolDays = schoolDaysSet.size;
            data.middle.schoolDays = schoolDaysSet.size;
            data.total.schoolDays = schoolDaysSet.size;
            
            // Set served days
            data.balvatika.served = data.balvatika.servedDays ? data.balvatika.servedDays.size : 0;
            data.primary.served = data.primary.servedDays ? data.primary.servedDays.size : 0;
            data.middle.served = data.middle.servedDays ? data.middle.servedDays.size : 0;
            data.total.served = new Set([
                ...(data.balvatika.servedDays || []),
                ...(data.primary.servedDays || []),
                ...(data.middle.servedDays || [])
            ]).size;
            
            // Update UI
            UI.mealsBalvatikaSchoolDays.value = data.balvatika.schoolDays;
            UI.mealsPrimarySchoolDays.value = data.primary.schoolDays;
            UI.mealsMiddleSchoolDays.value = data.middle.schoolDays;
            UI.mealsTotalSchoolDays.value = data.total.schoolDays;
            
            UI.mealsBalvatikaServed.value = data.balvatika.served;
            UI.mealsPrimaryServed.value = data.primary.served;
            UI.mealsMiddleServed.value = data.middle.served;
            UI.mealsTotalServed.value = data.total.served;
            
            UI.mealsBalvatikaTotal.value = data.balvatika.total;
            UI.mealsPrimaryTotal.value = data.primary.total;
            UI.mealsMiddleTotal.value = data.middle.total;
            UI.mealsTotalTotal.value = data.total.total;
            
            showToast('Meals details calculated successfully', 'success');
        }

        // Calculate fund details
        function calculateFundDetails() {
            const monthYear = UI.fundMonth.value;
            
            if (!monthYear) {
                showToast('Please select a month', 'warning');
                return;
            }
            
            // Parse month and year
            const [year, month] = monthYear.split('-').map(Number);
            
            // Get previous month
            let prevMonth = month - 1;
            let prevYear = year;
            if (prevMonth < 1) {
                prevMonth = 12;
                prevYear--;
            }
            
            // Get entries for selected month
            const monthEntries = state.entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get cash entries for selected month
            const monthCashEntries = state.cashEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Initialize data structure
            const data = {
                balvatika: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                primary: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                middle: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                total: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                }
            };
            
            // Get opening balances from previous month
            const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
            const savedBalances = localStorage.getItem(`poshanBalances_${prevMonthKey}`);
            
            if (savedBalances) {
                const balances = JSON.parse(savedBalances);
                data.balvatika.opening = balances.cash * 0.2;
                data.primary.opening = balances.cash * 0.4;
                data.middle.opening = balances.cash * 0.4;
                data.total.opening = balances.cash;
            } else {
                // Use default opening balances from settings
                data.balvatika.opening = state.settings.balances.cash * 0.2;
                data.primary.opening = state.settings.balances.cash * 0.4;
                data.middle.opening = state.settings.balances.cash * 0.4;
                data.total.opening = state.settings.balances.cash;
            }
            
            // Calculate received
            monthCashEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month - 1) {
                    data.balvatika.received += entry.balvatika;
                    data.primary.received += entry.primary;
                    data.middle.received += entry.middle;
                }
            });
            
            // Calculate expenditure
            monthEntries.forEach(entry => {
                data.balvatika.expenditure += entry.balvatika * (
                    state.settings.rates.dal.balvatika + 
                    state.settings.rates.oil.balvatika + 
                    state.settings.rates.salt.balvatika + 
                    state.settings.rates.fuel.balvatika
                );
                data.primary.expenditure += entry.primary * (
                    state.settings.rates.dal.primary + 
                    state.settings.rates.oil.primary + 
                    state.settings.rates.salt.primary + 
                    state.settings.rates.fuel.primary
                );
                data.middle.expenditure += entry.middle * (
                    state.settings.rates.dal.middle + 
                    state.settings.rates.oil.middle + 
                    state.settings.rates.salt.middle + 
                    state.settings.rates.fuel.middle
                );
            });
            
            // Calculate closing balances
            data.balvatika.closing = data.balvatika.opening + data.balvatika.received - data.balvatika.expenditure;
            data.primary.closing = data.primary.opening + data.primary.received - data.primary.expenditure;
            data.middle.closing = data.middle.opening + data.middle.received - data.middle.expenditure;
            data.total.closing = data.total.opening + data.total.received - data.total.expenditure;
            
            // Calculate totals
            data.total.received = data.balvatika.received + data.primary.received + data.middle.received;
            data.total.expenditure = data.balvatika.expenditure + data.primary.expenditure + data.middle.expenditure;
            
            // Update UI
            UI.fundBalvatikaOpening.value = data.balvatika.opening.toFixed(2);
            UI.fundPrimaryOpening.value = data.primary.opening.toFixed(2);
            UI.fundMiddleOpening.value = data.middle.opening.toFixed(2);
            UI.fundTotalOpening.value = data.total.opening.toFixed(2);
            
            UI.fundBalvatikaReceived.value = data.balvatika.received.toFixed(2);
            UI.fundPrimaryReceived.value = data.primary.received.toFixed(2);
            UI.fundMiddleReceived.value = data.middle.received.toFixed(2);
            UI.fundTotalReceived.value = data.total.received.toFixed(2);
            
            UI.fundBalvatikaExpenditure.value = data.balvatika.expenditure.toFixed(2);
            UI.fundPrimaryExpenditure.value = data.primary.expenditure.toFixed(2);
            UI.fundMiddleExpenditure.value = data.middle.expenditure.toFixed(2);
            UI.fundTotalExpenditure.value = data.total.expenditure.toFixed(2);
            
            UI.fundBalvatikaClosing.value = data.balvatika.closing.toFixed(2);
            UI.fundPrimaryClosing.value = data.primary.closing.toFixed(2);
            UI.fundMiddleClosing.value = data.middle.closing.toFixed(2);
            UI.fundTotalClosing.value = data.total.closing.toFixed(2);
            
            showToast('Fund details calculated successfully', 'success');
        }

        // Save all settings
        function saveAllSettings() {
            // Save all settings
            saveData();
            
            showToast('All settings saved successfully', 'success');
        }

        // Update UI with settings
        function updateUIWithSettings() {
            // Update dashboard
            UI.dashboardSchoolName.textContent = state.settings.schoolName;
            UI.dashboardUdise.textContent = state.settings.udise;
            
            // Update settings form
            UI.settingsSchoolName.value = state.settings.schoolName;
            UI.settingsUdise.value = state.settings.udise;
            UI.settingsBalvatikaRoll.value = state.settings.onRoll.balvatika;
            UI.settingsPrimaryRoll.value = state.settings.onRoll.primary;
            UI.settingsMiddleRoll.value = state.settings.onRoll.middle;
            
            // Update school details
            UI.settingsSchoolType.value = state.settings.schoolDetails.schoolType;
            UI.settingsSchoolCategory.value = state.settings.schoolDetails.schoolCategory;
            UI.settingsKitchenType.value = state.settings.schoolDetails.kitchenType;
            UI.settingsState.value = state.settings.schoolDetails.state;
            UI.settingsDistrict.value = state.settings.schoolDetails.district;
            UI.settingsBlock.value = state.settings.schoolDetails.block;
            UI.settingsVillage.value = state.settings.schoolDetails.village;
            UI.settingsNgo.value = state.settings.schoolDetails.ngo;
            
            // Update health details
            UI.healthIfaBoys.value = state.settings.healthDetails.ifaBoys;
            UI.healthIfaGirls.value = state.settings.healthDetails.ifaGirls;
            UI.healthScreened.value = state.settings.healthDetails.screened;
            UI.healthReferred.value = state.settings.healthDetails.referred;
            UI.healthInspectionDone.checked = state.settings.healthDetails.inspectionDone;
            UI.healthIncidents.value = state.settings.healthDetails.incidents;
            
            // Update commodity rates
            UI.settingsRiceBalvatika.value = state.settings.rates.rice.balvatika;
            UI.settingsRicePrimary.value = state.settings.rates.rice.primary;
            UI.settingsRiceMiddle.value = state.settings.rates.rice.middle;
            
            UI.settingsDalBalvatika.value = state.settings.rates.dal.balvatika;
            UI.settingsDalPrimary.value = state.settings.rates.dal.primary;
            UI.settingsDalMiddle.value = state.settings.rates.dal.middle;
            
            UI.settingsOilBalvatika.value = state.settings.rates.oil.balvatika;
            UI.settingsOilPrimary.value = state.settings.rates.oil.primary;
            UI.settingsOilMiddle.value = state.settings.rates.oil.middle;
            
            UI.settingsSaltBalvatika.value = state.settings.rates.salt.balvatika;
            UI.settingsSaltPrimary.value = state.settings.rates.salt.primary;
            UI.settingsSaltMiddle.value = state.settings.rates.salt.middle;
            
            UI.settingsFuelBalvatika.value = state.settings.rates.fuel.balvatika;
            UI.settingsFuelPrimary.value = state.settings.rates.fuel.primary;
            UI.settingsFuelMiddle.value = state.settings.rates.fuel.middle;
        }

        // Update dashboard
        function updateDashboard() {
            // Get today's date
            const today = new Date().toISOString().split('T')[0];
            
            // Find today's entry
            const todayEntry = state.entries.find(entry => entry.date === today);
            
            if (todayEntry) {
                UI.dashboardExpenditure.textContent = `₹${todayEntry.total.toFixed(2)}`;
                UI.dashboardRice.textContent = `${todayEntry.rice.toFixed(2)} kg`;
                UI.dashboardStudents.textContent = todayEntry.totalStudents;
            } else {
                UI.dashboardExpenditure.textContent = '₹0.00';
                UI.dashboardRice.textContent = '0 kg';
                UI.dashboardStudents.textContent = '0';
            }
            
            // Update attendance chart
            updateAttendanceChart();
        }

        // Create attendance chart
        function createAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            // Get current month and year
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Generate labels for each day
            const labels = [];
            for (let i = 1; i <= daysInMonth; i++) {
                labels.push(i.toString());
            }
            
            // Initialize data arrays
            const balvatikaData = new Array(daysInMonth).fill(0);
            const primaryData = new Array(daysInMonth).fill(0);
            const middleData = new Array(daysInMonth).fill(0);
            
            // Fill data arrays with entries
            state.entries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month) {
                    const day = entryDate.getDate() - 1; // Array is 0-indexed
                    if (day >= 0 && day < daysInMonth) {
                        balvatikaData[day] = entry.balvatika;
                        primaryData[day] = entry.primary;
                        middleData[day] = entry.middle;
                    }
                }
            });
            
            // Create chart
            window.attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Balvatika',
                            data: balvatikaData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Primary',
                            data: primaryData,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Middle',
                            data: middleData,
                            backgroundColor: 'rgba(255, 206, 86, 0.7)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    const day = context[0].label;
                                    const date = new Date(year, month, day);
                                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                                    return `${dayName}, ${formatDate(date, true)}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} students`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Highlight Sundays
            highlightSundays();
        }

        // Update attendance chart
        function updateAttendanceChart() {
            if (!window.attendanceChart) {
                createAttendanceChart();
                return;
            }
            
            // Get current month and year
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Initialize data arrays
            const balvatikaData = new Array(daysInMonth).fill(0);
            const primaryData = new Array(daysInMonth).fill(0);
            const middleData = new Array(daysInMonth).fill(0);
            
            // Fill data arrays with entries
            state.entries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month) {
                    const day = entryDate.getDate() - 1; // Array is 0-indexed
                    if (day >= 0 && day < daysInMonth) {
                        balvatikaData[day] = entry.balvatika;
                        primaryData[day] = entry.primary;
                        middleData[day] = entry.middle;
                    }
                }
            });
            
            // Update chart data
            window.attendanceChart.data.datasets[0].data = balvatikaData;
            window.attendanceChart.data.datasets[1].data = primaryData;
            window.attendanceChart.data.datasets[2].data = middleData;
            
            // Update chart
            window.attendanceChart.update();
            
            // Highlight Sundays
            highlightSundays();
        }

        // Highlight Sundays in the chart
        function highlightSundays() {
            if (!window.attendanceChart) return;
            
            // Get current month and year
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Create array of background colors
            const backgroundColors = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                // Sunday is 0
                if (date.getDay() === 0) {
                    backgroundColors.push('rgba(255, 0, 0, 0.2)');
                } else {
                    backgroundColors.push('rgba(0, 0, 0, 0)');
                }
            }
            
            // Update chart
            window.attendanceChart.options.scales.x.grid = {
                color: backgroundColors.map(color => color),
                lineWidth: 1
            };
            
            window.attendanceChart.update();
        }

        // Generate summary
        function generateSummary() {
            const monthYear = UI.summaryMonth.value;
            const category = UI.summaryCategory.value;
            
            if (!monthYear) {
                showToast('Please select a month', 'warning');
                return;
            }
            
            // Parse month and year
            const [year, month] = monthYear.split('-').map(Number);
            
            // Get entries for selected month
            const monthEntries = state.entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Clear table
            UI.summaryTable.querySelector('tbody').innerHTML = '';
            
            // Add rows to table
            let totalStudents = 0;
            let totalRice = 0;
            let totalExpenditure = 0;
            
            monthEntries.forEach((entry, index) => {
                let rowStudents = entry.totalStudents;
                let rowRice = entry.rice;
                let rowTotal = entry.total;
                
                // Filter by category if needed
                if (category !== 'all') {
                    if (category === 'balvatika') {
                        rowStudents = entry.balvatika;
                        rowRice = (entry.balvatika * state.settings.rates.rice.balvatika) / 1000;
                        rowTotal = entry.balvatika * (state.settings.rates.dal.balvatika + state.settings.rates.oil.balvatika + state.settings.rates.salt.balvatika + state.settings.rates.fuel.balvatika);
                    } else if (category === 'primary') {
                        rowStudents = entry.primary;
                        rowRice = (entry.primary * state.settings.rates.rice.primary) / 1000;
                        rowTotal = entry.primary * (state.settings.rates.dal.primary + state.settings.rates.oil.primary + state.settings.rates.salt.primary + state.settings.rates.fuel.primary);
                    } else if (category === 'middle') {
                        rowStudents = entry.middle;
                        rowRice = (entry.middle * state.settings.rates.rice.middle) / 1000;
                        rowTotal = entry.middle * (state.settings.rates.dal.middle + state.settings.rates.oil.middle + state.settings.rates.salt.middle + state.settings.rates.fuel.middle);
                    }
                }
                
                totalStudents += rowStudents;
                totalRice += rowRice;
                totalExpenditure += rowTotal;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formatDate(new Date(entry.date), true)}</td>
                    <td>${category === 'all' ? state.settings.onRoll.balvatika + state.settings.onRoll.primary + state.settings.onRoll.middle : 
                        category === 'balvatika' ? state.settings.onRoll.balvatika : 
                        category === 'primary' ? state.settings.onRoll.primary : 
                        state.settings.onRoll.middle}</td>
                    <td>${rowStudents}</td>
                    <td>${rowRice.toFixed(2)}</td>
                    <td>${rowTotal.toFixed(2)}</td>
                `;
                UI.summaryTable.querySelector('tbody').appendChild(row);
            });
            
            // Add total row
            if (monthEntries.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.innerHTML = `
                    <td colspan="3"><strong>Total</strong></td>
                    <td><strong>${totalStudents}</strong></td>
                    <td><strong>${totalRice.toFixed(2)}</strong></td>
                    <td><strong>${totalExpenditure.toFixed(2)}</strong></td>
                `;
                UI.summaryTable.querySelector('tbody').appendChild(totalRow);
            } else {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="6" class="text-center">No data available for the selected month</td>
                `;
                UI.summaryTable.querySelector('tbody').appendChild(noDataRow);
            }
        }

        // Generate abstracts
        function generateAbstracts() {
            const monthYear = UI.abstractsMonth.value;
            
            if (!monthYear) {
                showToast('Please select a month', 'warning');
                return;
            }
            
            // Parse month and year
            const [year, month] = monthYear.split('-').map(Number);
            
            // Get previous month
            let prevMonth = month - 1;
            let prevYear = year;
            if (prevMonth < 1) {
                prevMonth = 12;
                prevYear--;
            }
            
            // Get entries for selected month
            const monthEntries = state.entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get rice entries for selected month
            const monthRiceEntries = state.riceEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get cash entries for selected month
            const monthCashEntries = state.cashEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get opening balances
            let riceOpening = state.settings.balances.rice;
            let cashOpening = state.settings.balances.cash;
            
            // Check if we have balances for the previous month
            const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
            const savedBalances = localStorage.getItem(`poshanBalances_${prevMonthKey}`);
            
            if (savedBalances) {
                const balances = JSON.parse(savedBalances);
                riceOpening = balances.rice;
                cashOpening = balances.cash;
            }
            
            // Calculate category-wise rice abstracts
            let riceBalvatikaReceived = 0;
            let ricePrimaryReceived = 0;
            let riceMiddleReceived = 0;
            
            monthRiceEntries.forEach(entry => {
                riceBalvatikaReceived += entry.balvatika;
                ricePrimaryReceived += entry.primary;
                riceMiddleReceived += entry.middle;
            });
            
            let riceBalvatikaConsumed = 0;
            let ricePrimaryConsumed = 0;
            let riceMiddleConsumed = 0;
            
            monthEntries.forEach(entry => {
                riceBalvatikaConsumed += (entry.balvatika * state.settings.rates.rice.balvatika) / 1000;
                ricePrimaryConsumed += (entry.primary * state.settings.rates.rice.primary) / 1000;
                riceMiddleConsumed += (entry.middle * state.settings.rates.rice.middle) / 1000;
            });
            
            const riceBalvatikaBalance = riceOpening * 0.2 + riceBalvatikaReceived - riceBalvatikaConsumed;
            const ricePrimaryBalance = riceOpening * 0.4 + ricePrimaryReceived - ricePrimaryConsumed;
            const riceMiddleBalance = riceOpening * 0.4 + riceMiddleReceived - riceMiddleConsumed;
            const riceTotalBalance = riceBalvatikaBalance + ricePrimaryBalance + riceMiddleBalance;
            
            // Calculate category-wise cash abstracts
            let cashBalvatikaReceived = 0;
            let cashPrimaryReceived = 0;
            let cashMiddleReceived = 0;
            
            monthCashEntries.forEach(entry => {
                cashBalvatikaReceived += entry.balvatika;
                cashPrimaryReceived += entry.primary;
                cashMiddleReceived += entry.middle;
            });
            
            let cashBalvatikaExpenditure = 0;
            let cashPrimaryExpenditure = 0;
            let cashMiddleExpenditure = 0;
            
            monthEntries.forEach(entry => {
                cashBalvatikaExpenditure += entry.balvatika * (state.settings.rates.dal.balvatika + state.settings.rates.oil.balvatika + state.settings.rates.salt.balvatika + state.settings.rates.fuel.balvatika);
                cashPrimaryExpenditure += entry.primary * (state.settings.rates.dal.primary + state.settings.rates.oil.primary + state.settings.rates.salt.primary + state.settings.rates.fuel.primary);
                cashMiddleExpenditure += entry.middle * (state.settings.rates.dal.middle + state.settings.rates.oil.middle + state.settings.rates.salt.middle + state.settings.rates.fuel.middle);
            });
            
            const cashBalvatikaBalance = cashOpening * 0.2 + cashBalvatikaReceived - cashBalvatikaExpenditure;
            const cashPrimaryBalance = cashOpening * 0.4 + cashPrimaryReceived - cashPrimaryExpenditure;
            const cashMiddleBalance = cashOpening * 0.4 + cashMiddleReceived - cashMiddleExpenditure;
            const cashTotalBalance = cashBalvatikaBalance + cashPrimaryBalance + cashMiddleBalance;
            
            // Update UI
            // Rice Abstract
            UI.riceBalvatikaOpening.textContent = (riceOpening * 0.2).toFixed(2);
            UI.riceBalvatikaReceived.textContent = riceBalvatikaReceived.toFixed(2);
            UI.riceBalvatikaConsumed.textContent = riceBalvatikaConsumed.toFixed(2);
            UI.riceBalvatikaBalance.textContent = riceBalvatikaBalance.toFixed(2);
            
            UI.ricePrimaryOpening.textContent = (riceOpening * 0.4).toFixed(2);
            UI.ricePrimaryReceived.textContent = ricePrimaryReceived.toFixed(2);
            UI.ricePrimaryConsumed.textContent = ricePrimaryConsumed.toFixed(2);
            UI.ricePrimaryBalance.textContent = ricePrimaryBalance.toFixed(2);
            
            UI.riceMiddleOpening.textContent = (riceOpening * 0.4).toFixed(2);
            UI.riceMiddleReceived.textContent = riceMiddleReceived.toFixed(2);
            UI.riceMiddleConsumed.textContent = riceMiddleConsumed.toFixed(2);
            UI.riceMiddleBalance.textContent = riceMiddleBalance.toFixed(2);
            
            UI.riceTotalOpening.textContent = riceOpening.toFixed(2);
            UI.riceTotalReceived.textContent = (riceBalvatikaReceived + ricePrimaryReceived + riceMiddleReceived).toFixed(2);
            UI.riceTotalConsumed.textContent = (riceBalvatikaConsumed + ricePrimaryConsumed + riceMiddleConsumed).toFixed(2);
            UI.riceTotalBalance.textContent = riceTotalBalance.toFixed(2);
            
            // Cash Abstract
            UI.cashBalvatikaOpening.textContent = (cashOpening * 0.2).toFixed(2);
            UI.cashBalvatikaReceived.textContent = cashBalvatikaReceived.toFixed(2);
            UI.cashBalvatikaExpenditure.textContent = cashBalvatikaExpenditure.toFixed(2);
            UI.cashBalvatikaBalance.textContent = cashBalvatikaBalance.toFixed(2);
            
            UI.cashPrimaryOpening.textContent = (cashOpening * 0.4).toFixed(2);
            UI.cashPrimaryReceived.textContent = cashPrimaryReceived.toFixed(2);
            UI.cashPrimaryExpenditure.textContent = cashPrimaryExpenditure.toFixed(2);
            UI.cashPrimaryBalance.textContent = cashPrimaryBalance.toFixed(2);
            
            UI.cashMiddleOpening.textContent = (cashOpening * 0.4).toFixed(2);
            UI.cashMiddleReceived.textContent = cashMiddleReceived.toFixed(2);
            UI.cashMiddleExpenditure.textContent = cashMiddleExpenditure.toFixed(2);
            UI.cashMiddleBalance.textContent = cashMiddleBalance.toFixed(2);
            
            UI.cashTotalOpening.textContent = cashOpening.toFixed(2);
            UI.cashTotalReceived.textContent = (cashBalvatikaReceived + cashPrimaryReceived + cashMiddleReceived).toFixed(2);
            UI.cashTotalExpenditure.textContent = (cashBalvatikaExpenditure + cashPrimaryExpenditure + cashMiddleExpenditure).toFixed(2);
            UI.cashTotalBalance.textContent = cashTotalBalance.toFixed(2);
            
            // Save balances for current month
            const currentMonthKey = `${year}-${String(month).padStart(2, '0')}`;
            localStorage.setItem(`poshanBalances_${currentMonthKey}`, JSON.stringify({
                rice: riceTotalBalance,
                cash: cashTotalBalance
            }));
        }

        // Generate Official MDCF Report
        function generateOfficialMDCFReport() {
            const monthYear = UI.exportMonth.value;
            
            if (!monthYear) {
                showToast('Please select a month', 'warning');
                return;
            }
            
            // Parse month and year
            const [year, month] = monthYear.split('-').map(Number);
            
            // Show progress
            UI.exportProgressContainer.style.display = 'block';
            UI.exportProgressBar.style.width = '10%';
            UI.exportProgressText.textContent = 'Validating data...';
            
            // Get month name
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const monthName = monthNames[month - 1];
            
            // Get entries for selected month
            const monthEntries = state.entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get rice entries for selected month
            const monthRiceEntries = state.riceEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Get cash entries for selected month
            const monthCashEntries = state.cashEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getFullYear() === year && entryDate.getMonth() === month - 1;
            });
            
            // Validation checks
            let validationErrors = [];
            
            if (monthEntries.length === 0) {
                validationErrors.push(`No attendance records found for ${monthName} ${year}`);
            }
            
            // Update progress
            UI.exportProgressBar.style.width = '30%';
            UI.exportProgressText.textContent = 'Calculating meals data...';
            
            // Calculate meals data
            const mealsData = calculateMealsDataForExport(monthEntries, year, month);
            
            // Update progress
            UI.exportProgressBar.style.width = '50%';
            UI.exportProgressText.textContent = 'Calculating fund details...';
            
            // Calculate fund data
            const fundData = calculateFundDataForExport(monthCashEntries, year, month);
            
            // Update progress
            UI.exportProgressBar.style.width = '70%';
            UI.exportProgressText.textContent = 'Calculating grain details...';
            
            // Calculate grain data
            const grainData = calculateGrainDataForExport(monthRiceEntries, mealsData, year, month);
            
            // Update progress
            UI.exportProgressBar.style.width = '90%';
            UI.exportProgressText.textContent = 'Generating PDF...';
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text(`PM-POSHAN Mid-Day Meal Scheme`, 105, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text(`Monthly Data Collection Form (MDCF)`, 105, 22, { align: 'center' });
            
            // Add school details
            doc.setFontSize(10);
            doc.text(`School: ${state.settings.schoolName}`, 20, 30);
            doc.text(`UDISE: ${state.settings.udise}`, 20, 35);
            doc.text(`Month: ${monthName} ${year}`, 20, 40);
            
            // Section 1: School Details
            doc.setFontSize(12);
            doc.text('1. School Details', 20, 50);
            doc.setFontSize(10);
            doc.text(`School Type: ${state.settings.schoolDetails.schoolType.charAt(0).toUpperCase() + state.settings.schoolDetails.schoolType.slice(1)}`, 25, 55);
            doc.text(`School Category: ${state.settings.schoolDetails.schoolCategory.charAt(0).toUpperCase() + state.settings.schoolDetails.schoolCategory.slice(1)}`, 25, 60);
            doc.text(`Kitchen Type: ${state.settings.schoolDetails.kitchenType.charAt(0).toUpperCase() + state.settings.schoolDetails.kitchenType.slice(1)}`, 25, 65);
            doc.text(`State/UT: ${state.settings.schoolDetails.state}`, 25, 70);
            doc.text(`District: ${state.settings.schoolDetails.district}`, 25, 75);
            doc.text(`Block/NP: ${state.settings.schoolDetails.block}`, 25, 80);
            doc.text(`Village/Ward: ${state.settings.schoolDetails.village}`, 25, 85);
            
            // Section 2: Meals Availed Status
            doc.setFontSize(12);
            doc.text('2. Meals Availed Status', 20, 95);
            doc.setFontSize(10);
            
            const mealsTableHeaders = ['Category', 'School Days', 'MDM Days', 'Total Meals'];
            const mealsTableData = [
                ['Balvatika', mealsData.balvatika.schoolDays, mealsData.balvatika.served, mealsData.balvatika.total],
                ['Primary', mealsData.primary.schoolDays, mealsData.primary.served, mealsData.primary.total],
                ['Middle', mealsData.middle.schoolDays, mealsData.middle.served, mealsData.middle.total],
                
            ];
            
            doc.autoTable({
                head: [mealsTableHeaders],
                body: mealsTableData,
                startY: 100,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            
            // Section 3: Fund Details
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text('3. Fund Details (in ₹.)', 20, finalY);
            doc.setFontSize(10);
            
            const fundTableHeaders = ['Category', 'Opening', 'Received', 'Expenditure', 'Closing'];
            const fundTableData = [
                ['Balvatika', fundData.balvatika.opening, fundData.balvatika.received, fundData.balvatika.expenditure, fundData.balvatika.closing],
                ['Primary', fundData.primary.opening, fundData.primary.received, fundData.primary.expenditure, fundData.primary.closing],
                ['Middle', fundData.middle.opening, fundData.middle.received, fundData.middle.expenditure, fundData.middle.closing],
                
            ];
            
            doc.autoTable({
                head: [fundTableHeaders],
                body: fundTableData,
                startY: finalY + 5,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            
            // Section 4: Cook Cum Helper Payment Details
            finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text('4. Cook Cum Helper Payment Details', 20, finalY);
            doc.setFontSize(10);
            
            const helperTableHeaders = ['Name', 'Gender', 'Category', 'Payment Mode', 'Amount (Rs.)'];
            const helperTableData = [
                ['No helpers added', '', '', '', '']
            ];
            
            doc.autoTable({
                head: [helperTableHeaders],
                body: helperTableData,
                startY: finalY + 5,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            
            // Section 5: Food Grains Details (in Kg.)
            finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text('5. Food Grains Details (in Kg.)', 20, finalY);
            doc.setFontSize(10);
            
            const grainTableHeaders = ['Category', 'Opening', 'Received', 'Consumed', 'Closing'];
            const grainTableData = [
                ['Balvatika (Rice)', grainData.balvatika.opening, grainData.balvatika.received, grainData.balvatika.consumed, grainData.balvatika.closing],
                ['Primary (Rice)', grainData.primary.opening, grainData.primary.received, grainData.primary.consumed, grainData.primary.closing],
                ['Middle (Rice)', grainData.middle.opening, grainData.middle.received, grainData.middle.consumed, grainData.middle.closing],
               
            ];
            
            doc.autoTable({
                head: [grainTableHeaders],
                body: grainTableData,
                startY: finalY + 5,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            // Ensure totals are recalculated before PDF export

fundData.total.opening = fundData.balvatika.opening + fundData.primary.opening + fundData.middle.opening;
fundData.total.received = fundData.balvatika.received + fundData.primary.received + fundData.middle.received;
fundData.total.expenditure = fundData.balvatika.expenditure + fundData.primary.expenditure + fundData.middle.expenditure;

grainData.total.opening = grainData.balvatika.opening + grainData.primary.opening + grainData.middle.opening;
grainData.total.received = grainData.balvatika.received + grainData.primary.received + grainData.middle.received;
grainData.total.consumed = grainData.balvatika.consumed + grainData.primary.consumed + grainData.middle.consumed;
            
            // Section 6: Children Health Status
            finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text('6. Children Health Status', 20, finalY);
            doc.setFontSize(10);
            
            const healthTableHeaders = ['Particulars', 'Count'];
            const healthTableData = [
                ['IFA Tablets - Boys', state.settings.healthDetails.ifaBoys],
                ['IFA Tablets - Girls', state.settings.healthDetails.ifaGirls],
                ['Screened by RBSK Team', state.settings.healthDetails.screened],
                ['Referred by RBSK Team', state.settings.healthDetails.referred]
            ];
            
            doc.autoTable({
                head: [healthTableHeaders],
                body: healthTableData,
                startY: finalY + 5,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            
            // Section 7: Inspection Report
            finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text('7. Inspection Report', 20, finalY);
            doc.setFontSize(10);
            
            const inspectionTableHeaders = ['Particulars', 'Status/Count'];
            const inspectionTableData = [
                ['Inspection Done This Month', state.settings.healthDetails.inspectionDone ? 'Yes' : 'No'],
                ['Number of Untoward Incidents', state.settings.healthDetails.incidents]
            ];
            
            doc.autoTable({
                head: [inspectionTableHeaders],
                body: inspectionTableData,
                startY: finalY + 5,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [1, 87, 155],
                    textColor: 255
                }
            });
            
            // Add signature lines
            finalY = doc.lastAutoTable.finalY + 20;
            doc.text('Signature of Head Teacher', 40, finalY);
            doc.text('Signature of Cook-cum-Helper', 105, finalY);
            
            doc.line(30, finalY + 4, 70, finalY + 4);
            doc.line(95, finalY + 4, 135, finalY + 4);
            
            // Update progress
            UI.exportProgressBar.style.width = '100%';
            UI.exportProgressText.textContent = 'Complete!';
            
            // Save PDF
            const filename = `PM_POSHAN_MDCF_${state.settings.udise}_${month}${year}.pdf`;
            doc.save(filename);
            
            // Show success message
            UI.exportValidationMessage.className = 'validation-message success';
            UI.exportValidationMessage.textContent = 'Official PM POSHAN MDCF report generated successfully!';
            UI.exportValidationMessage.style.display = 'block';
            
            // Hide progress after a delay
            setTimeout(() => {
                UI.exportProgressContainer.style.display = 'none';
                UI.exportProgressBar.style.width = '0%';
            }, 2000);
            
            // Hide validation message after a delay
            setTimeout(() => {
                UI.exportValidationMessage.style.display = 'none';
            }, 5000);
            
            showToast('Official MDCF report exported successfully', 'success');
        }

        // Calculate meals data for export
        function calculateMealsDataForExport(entries, year, month) {
            // Initialize data structure
            const data = {
                balvatika: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                primary: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                middle: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                },
                total: {
                    schoolDays: 0,
                    served: 0,
                    total: 0
                }
            };
            
            // Get number of days in month
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Calculate school days (days with any attendance recorded)
            const schoolDaysSet = new Set();
            
            entries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month - 1) {
                    schoolDaysSet.add(entryDate.getDate());
                    
                    // Calculate total meals
                    data.balvatika.total += entry.balvatika;
                    data.primary.total += entry.primary;
                    data.middle.total += entry.middle;
                    
                    // Calculate served days (days with meal served)
                    if (entry.totalStudents > 0) {
                        if (!data.balvatika.servedDays) data.balvatika.servedDays = new Set();
                        if (!data.primary.servedDays) data.primary.servedDays = new Set();
                        if (!data.middle.servedDays) data.middle.servedDays = new Set();
                        
                        if (entry.balvatika > 0) data.balvatika.servedDays.add(entryDate.getDate());
                        if (entry.primary > 0) data.primary.servedDays.add(entryDate.getDate());
                        if (entry.middle > 0) data.middle.servedDays.add(entryDate.getDate());
                    }
                }
            });
            
            // Set school days
            data.balvatika.schoolDays = schoolDaysSet.size;
            data.primary.schoolDays = schoolDaysSet.size;
            data.middle.schoolDays = schoolDaysSet.size;
            data.total.schoolDays = schoolDaysSet.size;
            
            // Set served days
            data.balvatika.served = data.balvatika.servedDays ? data.balvatika.servedDays.size : 0;
            data.primary.served = data.primary.servedDays ? data.primary.servedDays.size : 0;
            data.middle.served = data.middle.servedDays ? data.middle.servedDays.size : 0;
            data.total.served = new Set([
                ...(data.balvatika.servedDays || []),
                ...(data.primary.servedDays || []),
                ...(data.middle.servedDays || [])
            ]).size;
            
            return data;
        }

        // Calculate fund data for export
        function calculateFundDataForExport(cashEntries, year, month) {
            // Initialize data structure
            const data = {
                balvatika: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                primary: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                middle: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                },
                total: {
                    opening: 0,
                    received: 0,
                    expenditure: 0,
                    closing: 0
                }
            };
            
            // Get previous month
            let prevMonth = month - 1;
            let prevYear = year;
            if (prevMonth < 1) {
                prevMonth = 12;
                prevYear--;
            }
            
            // Get opening balances from previous month
            const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
            const savedBalances = localStorage.getItem(`poshanBalances_${prevMonthKey}`);
            
            if (savedBalances) {
                const balances = JSON.parse(savedBalances);
                data.balvatika.opening = balances.cash * 0.2;
                data.primary.opening = balances.cash * 0.4;
                data.middle.opening = balances.cash * 0.4;
                data.total.opening = balances.cash;
            } else {
                // Use default opening balances from settings
                data.balvatika.opening = state.settings.balances.cash * 0.2;
                data.primary.opening = state.settings.balances.cash * 0.4;
                data.middle.opening = state.settings.balances.cash * 0.4;
                data.total.opening = state.settings.balances.cash;
            }
            
            // Calculate received and expenditure
            cashEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month - 1) {
                    data.balvatika.received += entry.balvatika;
                    data.primary.received += entry.primary;
                    data.middle.received += entry.middle;
                    
                    // Calculate expenditure based on entries
                    const entryForDate = state.entries.find(e => e.date === entry.date);
                    if (entryForDate) {
                        data.balvatika.expenditure += entryForDate.balvatika * (
                            state.settings.rates.dal.balvatika + 
                            state.settings.rates.oil.balvatika + 
                            state.settings.rates.salt.balvatika + 
                            state.settings.rates.fuel.balvatika
                        );
                        data.primary.expenditure += entryForDate.primary * (
                            state.settings.rates.dal.primary + 
                            state.settings.rates.oil.primary + 
                            state.settings.rates.salt.primary + 
                            state.settings.rates.fuel.primary
                        );
                        data.middle.expenditure += entryForDate.middle * (
                            state.settings.rates.dal.middle + 
                            state.settings.rates.oil.middle + 
                            state.settings.rates.salt.middle + 
                            state.settings.rates.fuel.middle
                        );
                    }
                }
            });
            
            // Calculate closing balances
            data.balvatika.closing = data.balvatika.opening + data.balvatika.received - data.balvatika.expenditure;
            data.primary.closing = data.primary.opening + data.primary.received - data.primary.expenditure;
            data.middle.closing = data.middle.opening + data.middle.received - data.middle.expenditure;
            data.total.closing = data.total.opening + data.total.received - data.total.expenditure;
            
            // Calculate totals
            data.total.received = data.balvatika.received + data.primary.received + data.middle.received;
            data.total.expenditure = data.balvatika.expenditure + data.primary.expenditure + data.middle.expenditure;
            
            return data;
        }

        // Calculate grain data for export
        function calculateGrainDataForExport(riceEntries, mealsData, year, month) {
            // Initialize data structure
            const data = {
                balvatika: {
                    opening: 0,
                    received: 0,
                    consumed: 0,
                    closing: 0
                },
                primary: {
                    opening: 0,
                    received: 0,
                    consumed: 0,
                    closing: 0
                },
                middle: {
                    opening: 0,
                    received: 0,
                    consumed: 0,
                    closing: 0
                },
                total: {
                    opening: 0,
                    received: 0,
                    consumed: 0,
                    closing: 0
                }
            };
            
            // Get previous month
            let prevMonth = month - 1;
            let prevYear = year;
            if (prevMonth < 1) {
                prevMonth = 12;
                prevYear--;
            }
            
            // Get opening balances from previous month
            const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
            const savedBalances = localStorage.getItem(`poshanBalances_${prevMonthKey}`);
            
            if (savedBalances) {
                const balances = JSON.parse(savedBalances);
                data.balvatika.opening = balances.rice * 0.2;
                data.primary.opening = balances.rice * 0.4;
                data.middle.opening = balances.rice * 0.4;
                data.total.opening = balances.rice;
            } else {
                // Use default opening balances from settings
                data.balvatika.opening = state.settings.balances.rice * 0.2;
                data.primary.opening = state.settings.balances.rice * 0.4;
                data.middle.opening = state.settings.balances.rice * 0.4;
                data.total.opening = state.settings.balances.rice;
            }
            
            // Calculate received
            riceEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate.getFullYear() === year && entryDate.getMonth() === month - 1) {
                    data.balvatika.received += entry.balvatika;
                    data.primary.received += entry.primary;
                    data.middle.received += entry.middle;
                }
            });
            
            // Calculate consumed based on meals served and entitlements
            data.balvatika.consumed = (mealsData.balvatika.total * state.settings.rates.rice.balvatika) / 1000;
            data.primary.consumed = (mealsData.primary.total * state.settings.rates.rice.primary) / 1000;
            data.middle.consumed = (mealsData.middle.total * state.settings.rates.rice.middle) / 1000;
            
            // Calculate closing balances
            data.balvatika.closing = data.balvatika.opening + data.balvatika.received - data.balvatika.consumed;
            data.primary.closing = data.primary.opening + data.primary.received - data.primary.consumed;
            data.middle.closing = data.middle.opening + data.middle.received - data.middle.consumed;
            data.total.closing = data.total.opening + data.total.received - data.total.consumed;
            
            // Calculate totals
            data.total.received = data.balvatika.received + data.primary.received + data.middle.received;
            data.total.consumed = data.balvatika.consumed + data.primary.consumed + data.middle.consumed;
            
            return data;
        }

        // Backup data
        function backupData() {
            const backup = {
                entries: state.entries,
                riceEntries: state.riceEntries,
                cashEntries: state.cashEntries,
                settings: state.settings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `poshan_backup_${formatDate(new Date(), true).replace(/-/g, '')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Data backup created successfully', 'success');
        }

        // Restore data
        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup
                    if (!backup.entries || !backup.riceEntries || !backup.cashEntries || !backup.settings) {
                        showToast('Invalid backup file', 'error');
                        return;
                    }
                    
                    // Show confirmation modal
                    UI.confirmationModalTitle.textContent = 'Restore Data';
                    UI.confirmationModalBody.textContent = 'This will replace all existing data. Are you sure you want to continue?';
                    
                    UI.confirmationModalConfirm.onclick = () => {
                        // Restore data
                        state.entries = backup.entries;
                        state.riceEntries = backup.riceEntries;
                        state.cashEntries = backup.cashEntries;
                        state.settings = backup.settings;
                        
                        // Ensure schoolDetails exists
                        if (!state.settings.schoolDetails) {
                            state.settings.schoolDetails = {
                                schoolType: 'government',
                                schoolCategory: 'primary',
                                kitchenType: 'local',
                                state: '',
                                district: '',
                                block: '',
                                village: '',
                                ngo: ''
                            };
                        }
                        
                        // Ensure healthDetails exists
                        if (!state.settings.healthDetails) {
                            state.settings.healthDetails = {
                                ifaBoys: 0,
                                ifaGirls: 0,
                                screened: 0,
                                referred: 0,
                                inspectionDone: false,
                                incidents: 0
                            };
                        }
                        
                        // Save to localStorage
                        saveData();
                        
                        // Update UI
                        updateUIWithSettings();
                        updateDashboard();
                        
                        // Show success message
                        showToast('Data restored successfully', 'success');
                        
                        UI.confirmationModal.hide();
                    };
                    
                    UI.confirmationModal.show();
                } catch (error) {
                    showToast('Error parsing backup file', 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Reset data
        function resetData() {
            // Show confirmation modal
            UI.confirmationModalTitle.textContent = 'Reset All Data';
            UI.confirmationModalBody.textContent = 'This will delete all entries, receipts, and settings. Are you sure you want to continue?';
            
            UI.confirmationModalConfirm.onclick = () => {
                // Reset state
                state.entries = [];
                state.riceEntries = [];
                state.cashEntries = [];
                state.settings = {
                    schoolName: 'School Name',
                    udise: '00000000000',
                    onRoll: {
                        balvatika: 0,
                        primary: 0,
                        middle: 0
                    },
                    rates: {
                        rice: {
                            balvatika: 100,
                            primary: 100,
                            middle: 150
                        },
                        dal: {
                            balvatika: 3.50,
                            primary: 3.50,
                            middle: 5.40
                        },
                        oil: {
                            balvatika: 1.10,
                            primary: 1.10,
                            middle: 2.00
                        },
                        salt: {
                            balvatika: 0.80,
                            primary: 0.80,
                            middle: 1.00
                        },
                        fuel: {
                            balvatika: 1.38,
                            primary: 1.38,
                            middle: 1.77
                        }
                    },
                    balances: {
                        rice: 0,
                        cash: 0
                    },
                    schoolDetails: {
                        schoolType: 'government',
                        schoolCategory: 'primary',
                        kitchenType: 'local',
                        state: 'Jammu and Kashmir',
                        district: 'Anantnag',
                        block: 'Vailoo',
                        village: '',
                        ngo: 'NA'
                    },
                    healthDetails: {
                        ifaBoys: 0,
                        ifaGirls: 0,
                        screened: 0,
                        referred: 0,
                        inspectionDone: false,
                        incidents: 0
                    }
                };
                
                // Clear localStorage
                localStorage.removeItem('poshanEntries');
                localStorage.removeItem('poshanRiceEntries');
                localStorage.removeItem('poshanCashEntries');
                localStorage.removeItem('poshanSettings');
                
                // Clear all balance data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('poshanBalances_')) {
                        localStorage.removeItem(key);
                    }
                }
                
                // Update UI
                updateUIWithSettings();
                updateDashboard();
                
                // Show success message
                showToast('All data has been reset', 'success');
                
                UI.confirmationModal.hide();
            };
            
            UI.confirmationModal.show();
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.id = toastId;
            
            let bgClass = 'bg-info';
            if (type === 'success') bgClass = 'bg-success';
            if (type === 'warning') bgClass = 'bg-warning';
            if (type === 'error') bgClass = 'bg-danger';
            
            toast.innerHTML = `
                <div class="toast-header ${bgClass} text-white">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            UI.toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            
            bsToast.show();
            
            // Remove toast element after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        function saveSettings() {
    // Update state from inputs
    state.settings.schoolName = UI.settingsSchoolName.value || 'School Name';
    state.settings.udise = UI.settingsUdise.value || '00000000000';
    state.settings.onRoll.balvatika = parseInt(UI.settingsBalvatikaRoll.value) || 0;
    state.settings.onRoll.primary = parseInt(UI.settingsPrimaryRoll.value) || 0;
    state.settings.onRoll.middle = parseInt(UI.settingsMiddleRoll.value) || 0;

    // School details
    state.settings.schoolDetails.schoolType = UI.settingsSchoolType.value;
    state.settings.schoolDetails.schoolCategory = UI.settingsSchoolCategory.value;
    state.settings.schoolDetails.kitchenType = UI.settingsKitchenType.value;
    state.settings.schoolDetails.state = UI.settingsState.value;
    state.settings.schoolDetails.district = UI.settingsDistrict.value;
    state.settings.schoolDetails.block = UI.settingsBlock.value;
    state.settings.schoolDetails.village = UI.settingsVillage.value;
    state.settings.schoolDetails.ngo = UI.settingsNgo.value;

    // Health details
    state.settings.healthDetails.ifaBoys = parseInt(UI.healthIfaBoys.value) || 0;
    state.settings.healthDetails.ifaGirls = parseInt(UI.healthIfaGirls.value) || 0;
    state.settings.healthDetails.screened = parseInt(UI.healthScreened.value) || 0;
    state.settings.healthDetails.referred = parseInt(UI.healthReferred.value) || 0;
    state.settings.healthDetails.inspectionDone = UI.healthInspectionDone.checked;
    state.settings.healthDetails.incidents = parseInt(UI.healthIncidents.value) || 0;

    // Save to localStorage
    localStorage.setItem('poshanSettings', JSON.stringify(state.settings));

    // Update dashboard immediately
    updateDashboard();
    showToast("Settings saved and will stay after refresh.");
}

// Hook up buttons
UI.settingsSchoolDetailsSaveBtn.addEventListener('click', saveSettings);
UI.settingsSaveAllBtn.addEventListener('click', saveSettings);
    </script>
</body>
</html>